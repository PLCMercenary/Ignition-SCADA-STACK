[{"id":"4f4627ba.0e9948","type":"tab","label":"SMS Castaway","disabled":false,"info":""},{"id":"1921c03.480d54","type":"mqtt-broker","z":"","name":"MQTT Health Broker","broker":"18.222.119.245","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"d2d1963f.98df78","type":"twilioConfig","z":"4f4627ba.0e9948","name":"Castaway 6"},{"id":"cf136759.d4dfe8","type":"twilioConfig","z":"4f4627ba.0e9948","name":"SCADABit Twilio Tyler"},{"id":"aeb55f67.408c4","type":"ui_group","z":"4f4627ba.0e9948","name":"Alarms","tab":"83d77fb8.f5e4f","order":2,"disp":true,"width":"6","collapse":false},{"id":"b4008bab.990648","type":"OpcUa-Endpoint","z":"4f4627ba.0e9948","endpoint":"opc.tcp://3.19.48.188:62541","secpol":"None","secmode":"NONE","login":false},{"id":"83d77fb8.f5e4f","type":"ui_tab","z":"4f4627ba.0e9948","name":"Tanks & Status","icon":"dashboard","order":2},{"id":"ebeb05e2.d1cda8","type":"postgresdb","z":"4f4627ba.0e9948","hostname":"ccs-scada.cluster-cfmgwesetfrr.us-east-2.rds.amazonaws.com","port":"8372","db":"postgres","ssl":false},{"id":"209e6cfc.972b44","type":"ui_base","theme":{"name":"theme-light","lightTheme":{"default":"#0094CE","baseColor":"#0094CE","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":true,"reset":false},"darkTheme":{"default":"#097479","baseColor":"#097479","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif","edited":false},"customTheme":{"name":"Untitled Theme 1","default":"#4B7930","baseColor":"#4B7930","baseFont":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"},"themeState":{"base-color":{"default":"#0094CE","value":"#0094CE","edited":false},"page-titlebar-backgroundColor":{"value":"#0094CE","edited":false},"page-backgroundColor":{"value":"#fafafa","edited":false},"page-sidebar-backgroundColor":{"value":"#ffffff","edited":false},"group-textColor":{"value":"#1bbfff","edited":false},"group-borderColor":{"value":"#ffffff","edited":false},"group-backgroundColor":{"value":"#ffffff","edited":false},"widget-textColor":{"value":"#111111","edited":false},"widget-backgroundColor":{"value":"#0094ce","edited":false},"widget-borderColor":{"value":"#ffffff","edited":false},"base-font":{"value":"-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen-Sans,Ubuntu,Cantarell,Helvetica Neue,sans-serif"}},"angularTheme":{"primary":"indigo","accents":"blue","warn":"red","background":"grey"}},"site":{"name":"Node-RED Dashboard","hideToolbar":"false","allowSwipe":"false","lockMenu":"false","allowTempTheme":"true","dateFormat":"DD/MM/YYYY","sizes":{"sx":48,"sy":48,"gx":6,"gy":6,"cx":6,"cy":6,"px":0,"py":0}}},{"id":"d3bfb5b9.4edaf8","type":"twilioConfig","z":"","name":"Hannathon Conroe"},{"id":"a8bd1e01.c7512","type":"twilioConfig","z":"","name":"SCADABit Twilio Tyler"},{"id":"c862bb66.f7f828","type":"ui_group","z":"","name":"Alarms","tab":"aebd3fe6.c545f","order":2,"disp":true,"width":"6","collapse":false},{"id":"ec5e6412.84b838","type":"ui_group","z":"","name":"Status","tab":"aebd3fe6.c545f","order":1,"disp":true,"width":"24","collapse":false},{"id":"173d23a.5b61ddc","type":"ui_group","z":"","name":"LACT2","tab":"b302ae87.8220b","order":2,"disp":true,"width":"8","collapse":false},{"id":"96acdfa.cb7b72","type":"ui_group","z":"","name":"LACT3","tab":"b302ae87.8220b","order":3,"disp":true,"width":"8","collapse":false},{"id":"7df2820.848878","type":"ui_group","z":"","name":"LACT1","tab":"b302ae87.8220b","order":1,"disp":true,"width":"8","collapse":false},{"id":"3a2681b.2b72d7e","type":"ui_group","z":"","name":"Trends","tab":"b302ae87.8220b","order":4,"disp":true,"width":"48","collapse":false},{"id":"5e2578b5.524f98","type":"mqtt-broker","z":"","name":"MQTT Health Broker","broker":"18.222.119.245","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"aebd3fe6.c545f","type":"ui_tab","z":"","name":"Tanks & Status","icon":"dashboard","order":1},{"id":"b302ae87.8220b","type":"ui_tab","z":"","name":"LACTs","icon":"dashboard","order":3},{"id":"11218457.cde5cc","type":"modbus-client","z":"","name":"GNA","clienttype":"tcp","bufferCommands":true,"stateLogEnabled":true,"tcpHost":"166.169.141.52","tcpPort":"502","tcpType":"DEFAULT","serialPort":"/dev/ttyUSB","serialType":"RTU-BUFFERD","serialBaudrate":"9600","serialDatabits":"8","serialStopbits":"1","serialParity":"none","serialConnectionDelay":"100","unit_id":"1","commandDelay":"1","clientTimeout":"3000","reconnectTimeout":"5000"},{"id":"d2eb8262.bb45a","type":"mqtt-broker","z":"","name":"will","broker":"ec2-3-133-117-64.us-east-2.compute.amazonaws.com","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"49b8c90.51d0c38","type":"protobuf-file","z":"","protopath":"/Users/twinflame_automation/Downloads/sparkplug_b.proto"},{"id":"a00e93ef.c0b63","type":"protobuf-file","z":"","protopath":"/Users/twinflame_automation/Downloads/sparkplug_b.proto.proto"},{"id":"d336782f.23d868","type":"protobuf-file","z":"","protopath":""},{"id":"3a10bd00.8c2724","type":"protobuf-file","z":"","protopath":"/home/dev/unsecured/sparkplug_b.proto"},{"id":"6994d8d6.d98538","type":"mqtt-broker","z":"","name":"Chariot","broker":"chariot.server.com","port":"8883","tls":"","clientid":"","usetls":true,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"3d7722b5.d3fcde","type":"protobuf-file","z":"","protopath":"/~/proto.proto"},{"id":"5baf9766.2f3f38","type":"protobuf-file","z":"","protopath":"/home/proto.proto"},{"id":"edbc28a9.af7be8","type":"protobuf-file","z":"","protopath":"/~/node_modules/spark.proto"},{"id":"70cddf3d.62aaf","type":"protobuf-file","z":"4f4627ba.0e9948","protopath":"/data/sparkplug_b.proto"},{"id":"c14296d8.0a8328","type":"protobuf-file","z":"","protopath":"/data/sparkplug_b.proto"},{"id":"627dff00.2244d","type":"sms","z":"4f4627ba.0e9948","name":"Customer Twilio","message":"","numbers":"+15752634941, +15757257206, +14326340166","throttle":"15000","twilio":"d2d1963f.98df78","x":2040,"y":300,"wires":[[]]},{"id":"e2c32a91.133f38","type":"trigger","z":"4f4627ba.0e9948","op1":"","op2":"bad","op1type":"pay","op2type":"str","duration":"15","extend":true,"units":"min","reset":"","bytopic":"all","name":"Comm Fail Message Trigger","x":493.9996109008789,"y":172.99998664855957,"wires":[["bebbc68a.e804d8"]]},{"id":"adc3050f.ddb218","type":"function","z":"4f4627ba.0e9948","name":"Comm Status Cache","func":"var m = \"Current Time        \" + msg.timeStamp\nm += \"\\nCastaway Compressor 6\\n\"\n\nvar scadaCommAlarm = flow.get(\"scadaCommAlarm\")\n\nif(msg.payload === \"bad\") {\n        flow.set(\"scadaCommAlarm\", \"Alarm\")\n    if(scadaCommAlarm === \"Normal\") {\n        \n        flow.set(\"scadaCommAlarmDate\", msg.timeStamp)\n        m += \"Alarm Active:   SCADA Communication Offline\"\n        msg.payload = m\n        return msg\n    }\n    \n} else {\n        flow.set(\"scadaCommAlarm\", \"Normal\")\n    if(scadaCommAlarm === \"Alarm\") {\n        \n        flow.set(\"scadaCommAlarmDate\", msg.timeStamp)\n        m += \"Alarm Cleared:  SCADA Communication Now Online\"\n        msg.payload = m\n        return msg\n    }  \n}","outputs":1,"noerr":0,"x":1080,"y":280,"wires":[["13b1cde6.a0bdd2","21cb7f8c.ab6da"]]},{"id":"562bde33.01802","type":"comment","z":"4f4627ba.0e9948","name":"CUSTOMER ALARMS","info":"","x":205.4996109008789,"y":63.99998664855957,"wires":[]},{"id":"bebbc68a.e804d8","type":"moment","z":"4f4627ba.0e9948","name":"Inject timeStamp","topic":"","input":"","inputType":"date","inTz":"America/Chicago","adjAmount":0,"adjType":"days","adjDir":"add","format":"MM/DD/YY hh:mm A","locale":"POSIX","output":"timeStamp","outputType":"msg","outTz":"America/Chicago","x":741.4996109008789,"y":173.99998664855957,"wires":[["adc3050f.ddb218"]]},{"id":"2ace5585.91a45a","type":"http in","z":"4f4627ba.0e9948","name":"Manual Get Status","url":"/get_status","method":"post","upload":false,"swaggerDoc":"","x":543.0135269165039,"y":54.999990463256836,"wires":[["a59d44be.5eace8"]]},{"id":"1d10c513.ad278b","type":"http response","z":"4f4627ba.0e9948","name":"Respond with Status Msg","statusCode":"200","headers":{"content-type":"text/plain"},"x":1587.024024963379,"y":46.874990463256836,"wires":[]},{"id":"ac9c6936.d92828","type":"function","z":"4f4627ba.0e9948","name":"Check Cmd Add Return Phone","func":"var cmd = msg.payload.Body.toLowerCase()\n\nif(cmd.indexOf(\"status\") !== -1 || cmd.indexOf(\"1\") !== -1) {\n    return msg\n} else if(cmd.indexOf(\"reset\") !== -1 || cmd.indexOf(\"2\") !== -1) {\n    return [null, msg]\n} else if(cmd.indexOf(\"setpoints\") !== -1 || cmd.indexOf(\"3\") !== -1) {\n    return [null, null, msg]\n} else if(cmd.indexOf(\"levels\") !== -1 || cmd.indexOf(\"4\") !== -1) {\n    return [null, null, null, msg]\n} else if(cmd.indexOf(\"ack\") !== -1 || cmd.indexOf(\"9\") !== -1) {\n    return [null, null, null, null, msg]\n} else if(cmd.indexOf(\"start\") == -1 && cmd.indexOf(\"stop\") == -1) {\n    return [null, null, null, null, null, msg]\n}\n// } else {\n//     return [null, null, null, msg]\n// }\n\n// else if(cmd.indexOf(\"setpoint\") !== -1 || cmd.indexOf(\"3\") !== -1) {\n//     return [null, null, msg]\n// }","outputs":6,"noerr":0,"x":985.0204849243164,"y":60.99998664855957,"wires":[["bb058f18.8479a"],["ef9dbc3c.f64d2","4d365cbb.a7b024"],["4f9af9ee.36ebe8"],["560375cf.c8fe8c"],["bb440aeb.8317e8"],["feba3e61.80593"]]},{"id":"560375cf.c8fe8c","type":"function","z":"4f4627ba.0e9948","name":"Send Status Message","func":"\n    var statusMsg = \"\\n\"\n    statusMsg += \"\\nCastaway 6\\n\"\n\n    // GET STATUS READ TIMESTAMP\n    var statusRegDate = flow.get(\"statusRegDate\")\n    var alarmRegDate = flow.get(\"alarmRegDate\")\n\n    var status = flow.get(\"Status\")\n    var alarms = flow.get(\"Alarms\")\n\n    var scadaCommAlarm = flow.get(\"scadaCommAlarm\")\n\n    const POINT_HEADER_DEF_LENGTH = 21\n\n    statusMsg = statusMsg + \"\\nStatus Time         \" + statusRegDate\n    status.sort()\n\n//spacing+naming\nvar sn = \"\\nPermissives:\"\nvar spa = \"\\n\"\n{\n    statusMsg = statusMsg + spa\n}\n\n{\n    statusMsg = statusMsg + sn + spa\n}\n//spacing+naming\n\nstatus.forEach(function(o){\n    var name = Object.keys(o)[0]\n    if(name == \"LACT 1 Perm\"){\n         var st = \"\\n\" + \"      \" + \"LACT 1\" + \": \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n        statusMsg = statusMsg + st + o[name]\n        \n    }\n    });\n\nstatus.forEach(function(o){\n    var name = Object.keys(o)[0]\n    if(name == \"LACT 2 Perm\"){\n         var st = \"\\n\" + \"      \" + \"LACT 2\" + \": \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n        statusMsg = statusMsg + st + o[name]\n        \n    }\n    });\n\nstatus.forEach(function(o){\n    var name = Object.keys(o)[0]\n    if(name == \"LACT 3 Perm\"){\n         var st = \"\\n\" + \"      \" + \"LACT 3\" + \": \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n        statusMsg = statusMsg + st + o[name]\n        \n    }\n    });\n    \n//spacing+naming\nvar sn = \"\\nRun:\"\nvar spa = \"\\n\"\n{\n    statusMsg = statusMsg + spa\n}\n\n{\n    statusMsg = statusMsg + sn + spa\n}\n//spacing+naming\n    \nstatus.forEach(function(o){\n    var name = Object.keys(o)[0]\n    if(name == \"LACT 1 Run\"){\n         var st = \"\\n\" + \"      \" + \"LACT 1\" + \": \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n        statusMsg = statusMsg + st + o[name]\n        \n    }\n    });\n\nstatus.forEach(function(o){\n    var name = Object.keys(o)[0]\n    if(name == \"LACT 2 Run\"){\n         var st = \"\\n\" + \"      \" + \"LACT 2\" + \": \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n        statusMsg = statusMsg + st + o[name]\n        \n    }\n    });\n\nstatus.forEach(function(o){\n    var name = Object.keys(o)[0]\n    if(name == \"LACT 3 Run\"){\n         var st = \"\\n\" + \"      \" + \"LACT 3\" + \": \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n        statusMsg = statusMsg + st + o[name]\n        \n    }\n    });\n \n//spacing+naming\nvar sn = \"\\nLevels:\"\nvar spa = \"\\n\"\n{\n    statusMsg = statusMsg + spa\n}\n\n{\n    statusMsg = statusMsg + sn + spa\n}\n//spacing+naming\n   \nstatus.forEach(function(o){\n    var name = Object.keys(o)[0]\n    if(name == \"LACT 1 Level\"){\n         var st = \"\\n\" + \"      \" + \"LACT 1\" + \": \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n                        var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt \n        \n    }\n    });    \n    \nstatus.forEach(function(o){\n    var name = Object.keys(o)[0]\n    if(name == \"LACT 2 Level\"){\n         var st = \"\\n\" + \"      \" + \"LACT 2\" + \": \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n                        var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt \n        \n    }\n    });\n    \nstatus.forEach(function(o){\n    var name = Object.keys(o)[0]\n    if(name == \"LACT 3 Level\"){\n         var st = \"\\n\" + \"      \" + \"LACT 3\" + \": \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n                        var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt \n        \n    }\n    });\n\n    var foundAlarm = false\n\n    alarms.forEach(function(o){\n        var name = Object.keys(o)[0]\n        if(o[name] === \"Alarm\") {\n\n            if(!foundAlarm) {\n            statusMsg = statusMsg + \"\\n\\nActive Alarms:\"\n            foundAlarm = true\n            }\n\n        var st = \"\\n\" + name\n      //  for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n     //       st = st + \" \"\n     //   }\n\n        statusMsg = statusMsg + st \n        }\n        \n    });\n\n//spacing+naming\nvar sn = \"\\nAlarms:\"\nvar spa = \"\\n\"\n{\n    statusMsg = statusMsg + spa\n}\n\n{\n    statusMsg = statusMsg + sn + spa\n}\n//spacing+naming\n\n\n    if(scadaCommAlarm === \"Alarm\") {\n    if(!foundAlarm) {\n    statusMsg = statusMsg + \"\\n\\nActive Alarms:\"\n    }\n\n    //statusMsg = statusMsg + \"\\nActive:  \" + scadaCommAlarmDate\n    statusMsg = statusMsg + \"\\nSCADA Communication Offline\"\n    foundAlarm = true  \n    }  \n\n  msg.payload = statusMsg\n  return msg;\n\n","outputs":1,"noerr":0,"x":1270.516944885254,"y":188.01040840148926,"wires":[["1d10c513.ad278b"]]},{"id":"a59d44be.5eace8","type":"moment","z":"4f4627ba.0e9948","name":"Inject timeStamp","topic":"","input":"","inputType":"date","inTz":"America/Chicago","adjAmount":0,"adjType":"days","adjDir":"add","format":"MM/DD/YY hh:mm A","locale":"POSIX","output":"timeStamp","outputType":"msg","outTz":"America/Chicago","x":743.5169296264648,"y":55.010403633117676,"wires":[["ac9c6936.d92828"]]},{"id":"1509e1ce.1a48ce","type":"cron","z":"4f4627ba.0e9948","name":"Status Message Schedule","crontab":"0 0,30 6-17 * * 1-5","x":190,"y":240,"wires":[[]]},{"id":"935ec248.01203","type":"comment","z":"4f4627ba.0e9948","name":"Mon-Fri 06:00AM-5:30PM 30 minutes","info":"","x":204.4996109008789,"y":206.01038932800293,"wires":[]},{"id":"3dbc1733.0ba148","type":"ui_button","z":"4f4627ba.0e9948","name":"Alarm Reset","group":"aeb55f67.408c4","order":1,"width":0,"height":0,"passthru":false,"label":"RESET ALARMS","tooltip":"","color":"","bgcolor":"red","icon":"","payload":"2","payloadType":"str","topic":"","x":190,"y":500,"wires":[["4d365cbb.a7b024"]]},{"id":"1ed2f799.908818","type":"modbus-write","z":"4f4627ba.0e9948","name":"Set/Reset Alarm Bit 0","showStatusActivities":false,"showErrors":false,"unitid":"1","dataType":"HoldingRegister","adr":"81","quantity":"1","server":"11218457.cde5cc","x":1054,"y":504,"wires":[[],[]]},{"id":"e3eaa5b.9277d58","type":"trigger","z":"4f4627ba.0e9948","op1":"1","op2":"0","op1type":"num","op2type":"num","duration":"5","extend":false,"units":"s","reset":"","bytopic":"all","name":"","x":614.0240135192871,"y":501.4103183746338,"wires":[["ffd19bde.7bcb38"]]},{"id":"ffd19bde.7bcb38","type":"function","z":"4f4627ba.0e9948","name":"Reset Cache","func":"if(msg.payload == 0) {\nflow.set(\"resetButton\", 0)\n} else {\nflow.set(\"resetButton\", 1)   \n}\nreturn msg\n\n\n","outputs":1,"noerr":0,"x":767.5170516967773,"y":502.51099586486816,"wires":[["1ed2f799.908818"]]},{"id":"ef9dbc3c.f64d2","type":"function","z":"4f4627ba.0e9948","name":"Send Reset Confirmation","func":"\n    var statusMsg = \"Current Time        \" + msg.timeStamp\n    statusMsg += \"\\nCastaway\\nAlarm Reset executed.\"\n    \n    // alarms = flow.get(\"Alarms\")\n    // alarm_names = Object.keys(alarms)\n    // var foundAlarm = false\n    \n    // alarm_names.forEach(function(a){\n\n        \n    // if(alarms)\n    \n    // if(!foundAlarm) {\n    // statusMsg = statusMsg + \"\\n\\nReset Alarms:\"\n    // }    \n    // statusMsg = statusMsg + \"\\nTank High-High Level\"\n    // foundAlarm = true\n        \n        \n        \n    // });\n\n    // if(!foundAlarm) {\n    // statusMsg = statusMsg + \"  There were no alarms to reset.\"\n    // }\n\n  msg.payload = statusMsg\n  return msg;\n\n","outputs":1,"noerr":0,"x":1286.523048400879,"y":101.03904914855957,"wires":[["1d10c513.ad278b"]]},{"id":"4d365cbb.a7b024","type":"function","z":"4f4627ba.0e9948","name":"Send and Set Cache","func":"var resetButton = flow.get(\"resetButton\")\n\nif(resetButton != 1) {\nflow.set(\"resetButton\", 1)     \nreturn msg\n}\n\n\n","outputs":1,"noerr":0,"x":420,"y":500,"wires":[["e3eaa5b.9277d58"]]},{"id":"83338c43.ad477","type":"inject","z":"4f4627ba.0e9948","name":"","topic":"","payload":"bad","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":262.9996109008789,"y":166.99998664855957,"wires":[["e2c32a91.133f38"]]},{"id":"feba3e61.80593","type":"function","z":"4f4627ba.0e9948","name":"Send Help Menu","func":"var statusMsg = \"Current Time        \" + msg.timeStamp\nstatusMsg += \"\\nError: Command not recognized.\\nTank Levels=1\\nReset Alarms=2\\nSetpoints=3\\nView Status=4\\nAckAlarm=9\"\n    \nmsg.payload = statusMsg\nreturn msg;\n\n","outputs":1,"noerr":0,"x":1266.5191650390625,"y":345.00391387939453,"wires":[["1d10c513.ad278b"]]},{"id":"cf708966.229ae8","type":"fastcsv","z":"4f4627ba.0e9948","name":"fastcsv","headers":true,"headerstr":"","ignoreEmpty":true,"discardUnmappedColumns":true,"strictColumnHandling":false,"delimiter":",","quote":"\"","escape":"\"","comment":"#","ltrim":false,"rtrim":false,"rowDelimiter":"\\n","includeEndRowDelimiter":false,"quoteHeaders":false,"quoteColumns":false,"x":176.01522064208984,"y":374.32813262939453,"wires":[["335b18d5.339328"]]},{"id":"d70067a.67e3498","type":"file in","z":"4f4627ba.0e9948","name":"Read Modbus Point Config","filename":"/data/modbus_points.csv","format":"utf8","chunk":false,"sendError":false,"encoding":"none","x":358.0191421508789,"y":300.71094512939453,"wires":[["cf708966.229ae8"]]},{"id":"5418452c.dd3e1c","type":"inject","z":"4f4627ba.0e9948","name":"","topic":"","payload":"","payloadType":"date","repeat":"180","crontab":"","once":true,"onceDelay":0.1,"x":110,"y":300,"wires":[["d70067a.67e3498"]]},{"id":"335b18d5.339328","type":"function","z":"4f4627ba.0e9948","name":"cacheConfig","func":"var pts = msg.payload\nvar points_lookup = {}\npts.forEach(function(p){\n    \n    if (points_lookup[p.reg_name]) {\n      points_lookup[p.reg_name].points.push({'bit': parseInt(p.bit), 'name': p.point_name, 'alias_on': p.alias_on, 'alias_off': p.alias_off, 'parse': p.parse})\n    } else {\n      points_lookup[p.reg_name] = {}\n      points_lookup[p.reg_name].name = p.reg_name\n      points_lookup[p.reg_name].parse = p.parse\n      points_lookup[p.reg_name].group = p.group\n      points_lookup[p.reg_name].quantity = p.quantity\n      points_lookup[p.reg_name].address = parseInt(p.reg_address)\n      points_lookup[p.reg_name].points = []\n      points_lookup[p.reg_name].points.push({'bit': parseInt(p.bit), 'name': p.point_name, 'alias_on': p.alias_on, 'alias_off': p.alias_off})\n    } \n});\n\nflow.set('points', points_lookup)        ","outputs":1,"noerr":0,"x":368.0230484008789,"y":378.35157108306885,"wires":[[]]},{"id":"6f938412.3240fc","type":"modbus-flex-getter","z":"4f4627ba.0e9948","name":"GNACompressor","showStatusActivities":false,"showErrors":false,"logIOActivities":false,"server":"11218457.cde5cc","useIOFile":false,"ioFile":"","useIOForPayload":false,"x":870,"y":620,"wires":[["e2c32a91.133f38","42ccbb90.4025f4"],["d9958f7a.0ad7e"]]},{"id":"bdfd71c2.ad898","type":"cron","z":"4f4627ba.0e9948","name":"","crontab":"*/3 * * * * *","x":170,"y":620,"wires":[["c296b46c.1d97b8","8e75c435.623048"]]},{"id":"4a9ba932.9fd048","type":"function","z":"4f4627ba.0e9948","name":"Loop Through Points","func":"var points = flow.get('points')\nvar modbusStatus = flow.get('modbusStatus')\nif(points && (modbusStatus.indexOf('active') != -1 || modbusStatus.indexOf('timeout') != -1)) {\nvar numPoints = Object.keys(points).length\nvar idx = flow.get('idx')\n\nif (idx === undefined || idx >= numPoints) {\n    idx = 0\n}\n\nvar names = Object.keys(points)\nmsg.points = points[names[idx]].points\nmsg.name = names[idx]\nmsg.parse = points[names[idx]].parse\nmsg.group = points[names[idx]].group\nnode.error(msg.name)\n\nmsg.payload = { value: msg.payload, 'fc': 3, 'unitid': 1, 'address': points[names[idx]].address, 'quantity': points[names[idx]].quantity }\n\nif(idx <= numPoints-1) {\n    idx += 1\n    flow.set('idx', idx)\n      \n} else {\nflow.set('idx', 0)  \n}\nreturn msg;  \n}\n\n","outputs":1,"noerr":0,"x":640,"y":620,"wires":[["6f938412.3240fc"]]},{"id":"c296b46c.1d97b8","type":"moment","z":"4f4627ba.0e9948","name":"Inject timeStamp","topic":"","input":"","inputType":"date","inTz":"America/Chicago","adjAmount":0,"adjType":"days","adjDir":"add","format":"MM/DD/YY hh:mm A","locale":"POSIX","output":"timeStamp","outputType":"msg","outTz":"America/Chicago","x":423.51913833618164,"y":616.0039052963257,"wires":[["4a9ba932.9fd048"]]},{"id":"991af622.964398","type":"comment","z":"4f4627ba.0e9948","name":"Poll once 3 seconds","info":"","x":197.0230484008789,"y":564.3515491485596,"wires":[]},{"id":"e16fe375.e5a9d","type":"inject","z":"4f4627ba.0e9948","name":"SEND RESET MANUALLY","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":150,"y":440,"wires":[["3dbc1733.0ba148","4d365cbb.a7b024"]]},{"id":"8872e3e0.87228","type":"status","z":"4f4627ba.0e9948","name":"sendgrid","scope":["6f938412.3240fc"],"x":459.99961853027344,"y":676.3333797454834,"wires":[["56d72080.3d516"]]},{"id":"56d72080.3d516","type":"function","z":"4f4627ba.0e9948","name":"modbus status","func":"flow.set(\"modbusStatus\",msg.status.text)","outputs":1,"noerr":0,"x":635.9996109008789,"y":673.9999866485596,"wires":[[]]},{"id":"d3daa01b.2a3ee","type":"inject","z":"4f4627ba.0e9948","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":100,"wires":[[]]},{"id":"42ccbb90.4025f4","type":"function","z":"4f4627ba.0e9948","name":"Parse Result","func":"\nif (msg.name == \"Status\") {\n  return msg\n} else if(msg.name.indexOf(\"Alarms\") != -1) {\nreturn [null,msg]    \n} else {\nreturn [null,null,msg]\n}\n\n\n\n","outputs":3,"noerr":0,"x":1101.5231094360352,"y":630.039083480835,"wires":[["bf29b25c.c098f"],["8bccdaec.c78ee8"],["beebdd14.5e74","d9958f7a.0ad7e"]]},{"id":"bf29b25c.c098f","type":"function","z":"4f4627ba.0e9948","name":"Parse Status","func":"flow.set(\"statusRegDate\", msg.timeStamp)\nvar status = flow.get(\"Status\")||[]\nvar names = []\nstatus.forEach(function(o){\n    names.push(Object.keys(o)[0])\n})\n// var names = Object.keys(status)\nvar r = msg.payload[0]\n\nmsg.points.forEach(function(p){\n    var val = \"\"\n    if((r & Math.pow(2,p.bit)) > 0) {\n        // var obj = {}\n        val = p.alias_on\n        // status.push(obj)\n    } else {\n        // var obj = {}\n        val = p.alias_off\n        // status.push(obj)\n    }\n    var idx = names.indexOf(p.name)\n    var o = {}\n    o[p.name] = val\n    if(idx == -1) {\n        status.push(o)\n    } else {\n        status[idx] = o\n    }\n});\n\nflow.set(\"Status\", status)","outputs":1,"noerr":0,"x":1271.023078918457,"y":587.7032012939453,"wires":[[]]},{"id":"8bccdaec.c78ee8","type":"function","z":"4f4627ba.0e9948","name":"Parse Alarms","func":"\nvar alarmMsg = \"Current Time        \" + msg.timeStamp\nalarmMsg += \"\\nCastaway\"\nvar voiceMsg = \"Hello. There are active alarms at location. Castaway. \"\n\nvar newAlarm = false\n\nflow.set(\"alarmRegDate\", msg.timeStamp)\nvar alarms = flow.get(\"Alarms\")||[]\nvar old_names = []\nalarms.forEach(function(a){\n  old_names.push(Object.keys(a)[0]) \n});\n\n// var new_alarms = []\nvar r = msg.payload[0]\n\nmsg.points.forEach(function(p){\n    // ignore spamming Tank 2 L Alarm 10-18-2019 will\n  if(p.name.indexOf('L Alarm') == -1) {\n       \n     if((r & Math.pow(2,p.bit)) > 0) {\n      var obj = {}\n      obj[p.name] = p.alias_on\n    //   new_alarms.push(obj)\n     } else {\n      var obj = {}\n      obj[p.name] = p.alias_off\n    //   new_alarms.push(obj)\n     }\n    \n    // node.error(old_names)\n    var idx = old_names.indexOf(p.name)\n    // node.error('INDEX OF NAME')\n    // node.error(idx)\n    \n    if (idx != -1) {\n        // node.error('obj[p.name]')\n        // node.error(obj[p.name])\n        // node.error('alarms[idx][p.name]')\n        // node.error(alarms[idx][p.name])        \n        \n        \n        if(alarms[idx][p.name] != obj[p.name]) {\n          if(obj[p.name] == p.alias_on) {\n             alarmMsg = alarmMsg + \"\\nAlarm Active:   \" + p.name\n             voiceMsg = voiceMsg + \"Active. \" + p.name + \".\"\n          } else {\n             alarmMsg = alarmMsg + \"\\nAlarm Cleared:  \" + p.name\n          }\n          newAlarm = true\n        } \n        \n        alarms[idx][p.name] = obj[p.name]\n        \n    } else {\n        alarms.push(obj)\n    }\n    \n  }\n    \n});\n\n\n\nflow.set(\"Alarms\", alarms)\n\nif(newAlarm) {\n    var alarmActive = false\n    alarms.forEach(function(a){\n        var val = Object.keys(a)[0]\n        val = a[val]\n        val = val.toLowerCase()\n        if(val.indexOf(\"alarm\") !== -1) {\n            alarmActive = true\n        }\n    });\n    flow.set('alarmActive', alarmActive)\n    // if active alarm, call and text\n    if(alarmMsg.indexOf('Alarm Active') != -1) {\n        voiceMsg = voiceMsg + \". Press any key to acknowledge the alarm.\"\n        flow.set('voiceMsg', voiceMsg)\n        return [{\"payload\": alarmMsg}, {\"payload\": voiceMsg, 'reset': true}]\n    } else {\n    return {\"payload\": alarmMsg}     \n    }\n    // if alarm clear, just text\n   \n} \n\n\n\n\n\n\n\n\n\n\n\n// var alarmMsg = \"Current Time        \" + msg.timeStamp\n// alarmMsg += \"\\nConroe\"\n\n// var voiceMessage = \"Hello. There are active alarms at location. Conroe. \"\n\n// var newAlarm = false\n\n// flow.set(\"alarmRegDate\", msg.timeStamp)\n// var old_alarms = flow.get(\"Alarms\")||[]\n// var old_names = []\n// old_alarms.forEach(function(a){\n//   old_names.push(Object.keys(a)[0]) \n// });\n\n// var new_alarms = []\n// var r = msg.payload[0]\n\n// msg.points.forEach(function(p){\n\n//      if((r & Math.pow(2,p.bit)) > 0) {\n//       var obj = {}\n//       obj[p.name] = p.alias_on\n//       new_alarms.push(obj)\n//      } else {\n//       var obj = {}\n//       obj[p.name] = p.alias_off\n//       new_alarms.push(obj)\n//      }\n    \n//     // node.error(old_names)\n//     var idx = old_names.indexOf(p.name)\n//     // node.error('INDEX OF NAME')\n//     // node.error(idx)\n    \n//     if (idx != -1) {\n//         // node.error('obj[p.name]')\n//         // node.error(obj[p.name])\n//         // node.error('old_alarms[idx][p.name]')\n//         // node.error(old_alarms[idx][p.name])        \n        \n//         if(old_alarms[idx][p.name] != obj[p.name]) {\n//           if(obj[p.name] == p.alias_on) {\n//              alarmMsg = alarmMsg + \"\\nAlarm Active:   \" + p.name\n//              voiceMsg = voiceMsg + \"Active:   \" + p.name + \".\"\n//           } else {\n//              alarmMsg = alarmMsg + \"\\nAlarm Cleared:  \" + p.name\n//           }\n//           newAlarm = true\n//         } \n//     }\n    \n// });\n\n\n\n// flow.set(\"Alarms\", new_alarms)\n\n// if(newAlarm) {\n//     // if active alarm, call and text\n//     if(alarmMsg.indexOf('Alarm Active') != -1) {\n//         return [{\"payload\": alarmMsg}, {\"payload\": voiceMsg, 'reset': true}]\n//     } else {\n//     return {\"payload\": alarmMsg}     \n//     }\n//     // if alarm clear, just text\n   \n// } \n","outputs":2,"noerr":0,"x":1310,"y":640,"wires":[["a5f12324.6eb59"],[]]},{"id":"beebdd14.5e74","type":"function","z":"4f4627ba.0e9948","name":"Parse Register Value","func":"if(msg.parse.length > 0) {\nvar parse = JSON.parse(msg.parse)\nvar val = msg.payload\n\n\nparse.forEach(function(p){\n    \nswitch(p.func) {\n    \ncase \"float32ToNum\":\nvar bits = (val[0] << 16 | val[1]);\nvar sign = ((bits >>> 31) === 0) ? 1.0 : -1.0;\nvar e = ((bits >>> 23) & 0xff);\nvar m = (e === 0) ? (bits & 0x7fffff) << 1 : (bits & 0x7fffff) | 0x800000;\nvar f = sign * m * Math.pow(2, e - 150);\nf = Math.fround(f);\nf = parseFloat(f)\nf = f.toFixed(2)\nval = f\nbreak;\n\ncase \"scale\":\n    if(val.constructor == Array) {\n        val = val[0]    \n    } \n    \n    val = val * p.param\nbreak;  \n\ncase \"lact1SelectTank\":\n    if(val.constructor == Array) {\n        val = val[0]    \n    } \n    for(var i = 1; i <= 3; i++) {\n        if((val & Math.pow(2,i)) > 0) {\n            var num = i + 1;\n            val = \"Tank \" + num\n            i = 16\n        }\n    }\n    \n    if(val.constructor == Number) {\n        val = \"Error\"\n    }\n    // val = val * p.param\n\nbreak;   \n\ncase \"lact2SelectTank\":\n    if(val.constructor == Array) {\n        val = val[0]    \n    } \n    for(var i = 4; i <= 5; i++) {\n        if((val & Math.pow(2,i)) > 0) {\n            var num = i + 1;\n            val = \"Tank \" + num\n            i = 16\n        }\n    }\n    \n    if(val.constructor == Number) {\n        val = \"Error\"\n    }\n    // val = val * p.param\n\nbreak;  \n\ncase \"lact3SelectTank\":\n    if(val.constructor == Array) {\n        val = val[0]    \n    } \n    for(var i = 6; i <= 8; i++) {\n        if((val & Math.pow(2,i)) > 0) {\n            var num = i + 1;\n            val = \"Tank \" + num\n            i = 16\n        }\n    }\n    \n    if(val.constructor == Number) {\n        val = \"Error\"\n    }\n    // val = val * p.param\n\nbreak;  \n\n\ncase \"alias\":\n    if(val.constructor == Array) {\n        val = val[0]    \n    } \n    \n    val = p.param[val]\n    \nbreak;\n\ncase \"int32ABCD\":\n    if(val.constructor == Array) {\n        val = (val[0] << 16) + val[1]   \n    } else {\n        val = val\n    }\n    \nbreak;\n\n// LACT 1: 2,3,4\n// LACT 2: 5,6\n// LACT 3: 7,8,9\n\n\ndefault:\nnode.error('DIDNT FIND PARSER')\n    val = msg.payload[0]\n    break;\n\n}\n\n});\n} else {\n    // default for no parser is single reg value int\n    var val = msg.payload[0]\n}\n\n\n// cache value\nvar status = flow.get(msg.group)||[]\nvar names = []\nstatus.forEach(function(o){\n    names.push(Object.keys(o)[0])\n})\n\nvar idx = names.indexOf(msg.name)\nvar o = {}\no[msg.name] = val\nif(idx == -1) {\n    status.push(o)\n} else {\n    status[idx] = o\n}\n\n\nflow.set(msg.group, status)","outputs":1,"noerr":0,"x":1300,"y":780,"wires":[[]]},{"id":"d9958f7a.0ad7e","type":"debug","z":"4f4627ba.0e9948","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1330,"y":940,"wires":[]},{"id":"e577c1b6.9dc1b","type":"function","z":"4f4627ba.0e9948","name":"CLEAR CACHE","func":"// flow.set('scadaCommAlarm', \"Alarm\")\n// flow.set('Alarms', undefined)\n// flow.set('points', undefined)","outputs":1,"noerr":0,"x":743.0386734008789,"y":840.9374866485596,"wires":[[]]},{"id":"873c6378.352b8","type":"inject","z":"4f4627ba.0e9948","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":520,"y":840,"wires":[["e577c1b6.9dc1b"]]},{"id":"b45641ac.874e9","type":"function","z":"4f4627ba.0e9948","name":"Send Command Start","func":"\n    var m = \"Current Time        \" + msg.timeStamp\n    m += \"\\nSCADACloud Administrator\\n requested password for user J***e*y is d54oYLn2\"\n    \n    // alarms = flow.get(\"Alarms\")\n    // alarm_names = Object.keys(alarms)\n    // var foundAlarm = false\n    \n    // alarm_names.forEach(function(a){\n\n        \n    // if(alarms)\n    \n    // if(!foundAlarm) {\n    // statusMsg = statusMsg + \"\\n\\nReset Alarms:\"\n    // }    \n    // statusMsg = statusMsg + \"\\nTank High-High Level\"\n    // foundAlarm = true\n        \n        \n        \n    // });\n\n    // if(!foundAlarm) {\n    // statusMsg = statusMsg + \"  There were no alarms to reset.\"\n    // }\n\n  msg.payload = m\n  return msg;\n\n","outputs":1,"noerr":0,"x":1800,"y":220,"wires":[["1e81244a.d1a53c"]]},{"id":"3546420d.23ac4e","type":"comment","z":"4f4627ba.0e9948","name":"CLEAR CACHE","info":"","x":680,"y":780,"wires":[]},{"id":"25c6907.95f7d7","type":"comment","z":"4f4627ba.0e9948","name":"WELCOME MESSAGE","info":"","x":679.5230484008789,"y":916.0390491485596,"wires":[]},{"id":"bb058f18.8479a","type":"function","z":"4f4627ba.0e9948","name":"Send Levels","func":"\n    var statusMsg = \"\\n\"\n    statusMsg += \"\\nCastaway 6 Compressor\\n\"\n\n    // GET STATUS READ TIMESTAMP\n    var statusRegDate = flow.get(\"statusRegDate\")\n    var status = flow.get(\"Levels\")\n\n    const POINT_HEADER_DEF_LENGTH = 21\n\n    statusMsg = statusMsg + \"\\nLevels Update Time         \" + statusRegDate\n    status.sort()\n\n//spacing+naming\nvar sn = \"\\nWater:\"\nvar spa = \"\\n\"\n{\n    statusMsg = statusMsg + spa\n}\n\n{\n    statusMsg = statusMsg + sn + spa\n}\n//spacing+naming\n\n//Call each by name for spacing/sorting\n    status.forEach(function(o){\n        var name = Object.keys(o)[0]\n        if(name == \"Water Tank Level\"){\n         var st = \"\\n\" + \"      \" + \"Tank\" + \" (Ft): \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n        \n                var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt             \n        }\n    });   \n\n//spacing+naming\nvar sn = \"\\nConroe 1:\"\nvar spa = \"\\n\"\n{\n    statusMsg = statusMsg + spa\n}\n\n{\n    statusMsg = statusMsg + sn + spa\n}\n//spacing+naming\n\n    status.forEach(function(o){\n        var name = Object.keys(o)[0]\n        if(name == \"Conroe #1 Tank 1 Level\"){\n         var st = \"\\n\" + \"      \" + \"Tank 1\" + \" (Ft): \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n                var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt           \n        }\n    });    \n\n\n    status.forEach(function(o){\n        var name = Object.keys(o)[0]\n        if(name == \"Conroe #1 Tank 2 Level\"){\n         var st = \"\\n\" + \"      \" + \"Tank 2\" + \" (Ft): \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n                var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt          \n        }\n    });    \n\n    status.forEach(function(o){\n        var name = Object.keys(o)[0]\n        if(name == \"Conroe #1 Tank 3 Level\"){\n         var st = \"\\n\" + \"      \" + \"Tank 3\" + \" (Ft): \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n                var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt         \n        }\n    });   \n\n//spacing+naming\nvar sn = \"\\nMidland:\"\nvar spa = \"\\n\"\n{\n    statusMsg = statusMsg + spa\n}\n\n{\n    statusMsg = statusMsg + sn + spa\n}\n//spacing+naming\n\n    status.forEach(function(o){\n        var name = Object.keys(o)[0]\n        if(name == \"Midland Tank 1 Level\"){\n         var st = \"\\n\" + \"      \" + \"Tank 1\" + \" (Ft): \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n                var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt           \n        }\n    });   \n\n    status.forEach(function(o){\n        var name = Object.keys(o)[0]\n        if(name == \"Midland Tank 2 Level\"){\n         var st = \"\\n\" + \"      \" + \"Tamk 2\" + \" (Ft): \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n                var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt            \n        }\n    });   \n\n//spacing+naming\nvar sn = \"\\nConroe 2:\"\nvar spa = \"\\n\"\n{\n    statusMsg = statusMsg + spa\n}\n\n{\n    statusMsg = statusMsg + sn + spa\n}\n//spacing+naming\n\n    status.forEach(function(o){\n        var name = Object.keys(o)[0]\n        if(name == \"Conroe #2 Tank 1 Level\"){\n         var st = \"\\n\" + \"      \" + \"Tank 1\" + \" (Ft): \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n                var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt           \n        }\n    });\n\n    status.forEach(function(o){\n        var name = Object.keys(o)[0]    \n        if(name == \"Conroe #2 Tank 2 Level\"){\n         var st = \"\\n\" + \"      \" + \"Tank 2\" + \" (Ft): \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n                var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt            \n        }\n    });\n\n    status.forEach(function(o){\n        var name = Object.keys(o)[0]    \n        if(name == \"Conroe #2 Tank 3 Level\"){\n         var st = \"\\n\" + \"      \" + \"Tank 3\" + \" (Ft): \"\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n                var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt            \n        }\n    });\n\n  msg.payload = statusMsg\n  return msg;\n\n","outputs":1,"noerr":0,"x":1271.499610900879,"y":54.99998664855957,"wires":[["1d10c513.ad278b"]]},{"id":"4f9af9ee.36ebe8","type":"function","z":"4f4627ba.0e9948","name":"Send Setpoints","func":"\n    var statusMsg = \"Current Time        \" + msg.timeStamp\n    statusMsg += \"\\nCastaway\\nSetpoints Update:\"\n\n    // GET STATUS READ TIMESTAMP\n    var statusRegDate = flow.get(\"statusRegDate\")\n    var status = flow.get(\"Setpoints\")\n\n    const POINT_HEADER_DEF_LENGTH = 21\n\n    statusMsg = statusMsg + \"\\nSetpoints Time         \" + statusRegDate\n    status.sort()\n\n    status.forEach(function(o){\n\n        var name = Object.keys(o)[0]\n\n         var st = \"\\n\" + name\n        for(var i = st.length; i < POINT_HEADER_DEF_LENGTH; i++) {\n            st = st + \" \"\n        }\n        if(name.indexOf(\"Select\") != -1) {\n        statusMsg = statusMsg + st + o[name]      \n        } else {\n                    var whole = o[name]\n        var feet = Math.floor(whole)\n        var part = ((whole - feet) * 12)\n        var inch = Math.floor(part)\n        var part2 = ((inch - part) * 16)\n        var frac = Math.floor(part2)\n        frac = frac * -1\n        dem = \"/16\"\n        \n        msgFt = feet + \" (ft), \" + inch + \" (\" + frac + dem + \") (in)\"\n        \n        statusMsg = statusMsg + st + msgFt  \n        }\n                 \n    \n    });\n\n  msg.payload = statusMsg\n  return msg;\n\n","outputs":1,"noerr":0,"x":1267.499610900879,"y":149.99998664855957,"wires":[["1d10c513.ad278b"]]},{"id":"72af050c.ed643c","type":"http in","z":"4f4627ba.0e9948","name":"Alarm Call Pickup","url":"/call_answered","method":"post","upload":false,"swaggerDoc":"","x":1814.5034866333008,"y":1235.0350551605225,"wires":[["6e7fef92.fcd1"]]},{"id":"c3e351fd.e983e","type":"http response","z":"4f4627ba.0e9948","name":"Send TwiML","statusCode":"200","headers":{},"x":2219.503486633301,"y":1236.0350551605225,"wires":[]},{"id":"64a945ac.65ea4c","type":"function","z":"4f4627ba.0e9948","name":"Start Call","func":"// msg.headers = {\"Content-Type\": \"application/x-www-form-urlencoded\"}\n// msg.headers = {\"Content-Type\": \"application/json\"}\n// msg.payload = {\"From\": \"+14322162465\", \"To\": \"+14696512674\", \"Url\": \"http://ec2-18-218-144-146.us-east-2.compute.amazonaws.com:1880/call_answered\"}\n// msg.url = \"https://api.twilio.com/2010-04-01/Accounts/ACd3d1e28d6055eac9af7579cbe9b2df67/Calls?To=14696512674&From=+14322162465&Url=http://ec2-18-218-144-146.us-east-2.compute.amazonaws.com:1880/call_answered\"\n// msg.url = \"https://api.twilio.com/2010-04-01/Accounts/ACd3d1e28d6055eac9af7579cbe9b2df67/Calls.json?To%3D%2B14696512674%26From%3D%2B14322162465%26\"\n// msg.url = \"https%3A%2F%2Fapi.twilio.com%2F2010-04-01%2FAccounts%2FACd3d1e28d6055eac9af7579cbe9b2df67%2FCalls%3FTo%3D%2B14696512674%26From%3D%2B14322162465%26Url%3Dhttp%3A%2F%2Fec2-18-218-144-146.us-east-2.compute.amazonaws.com%3A1880%2Fcall_answered\"\n\n// Download the helper library from https://www.twilio.com/docs/node/install\n// Your Account Sid and Auth Token from twilio.com/console\nnode.error(\"MESSAGE IN CALL\")\nnode.error(msg)\nvar ack = flow.get('alarmAcked')||false\nif(!ack || msg.reset) {\n    if(msg.reset) {\n        flow.set('alarmAcked', false)\n    }\nvar twilio = global.get('twilio')\nconst accountSid = 'ACd3d1e28d6055eac9af7579cbe9b2df67';\nconst authToken = '075c463b1989281acdfe67dd508ea15a';\nconst client = twilio(accountSid, authToken);\n\nvar users = flow.get('alarmContacts')  \nvar nums = Object.keys(users)\nvar numIndex = flow.get('numIndex')||0\n\nif(numIndex >= nums.length) {\n    numIndex = 0\n} else if(msg.reset) {\n    numIndex = 0\n}\nnode.error(numIndex)\nvar to = nums[numIndex]\nnode.error(\"ALARM CALL NOW\")\nnode.error(to)\nnumIndex = numIndex + 1\nflow.set('numIndex', numIndex)\n\nclient.calls\n      .create({\n         url: 'http://ec2-18-219-204-251.us-east-2.compute.amazonaws.com:1880/call_answered',\n         to: to,\n         from: '+14322871589'\n      })\n      .then(call => node.error(call.sid))\n      .done(node.error);\n      \n      \nreturn {'payload': 0}\n}","outputs":1,"noerr":0,"x":1657.5040588378906,"y":970.0352802276611,"wires":[["4d358133.83c4"]]},{"id":"6e7fef92.fcd1","type":"function","z":"4f4627ba.0e9948","name":"Process Call","func":"// node.error(\"CALL PICKED UP\")\n// var twiml_response = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\" standalone=\\\"yes\\\"?> \\\n//     <Response> \\\n//     <Gather action=\\\"http://ec2-13-59-107-160.us-east-2.compute.amazonaws.com:1880/operator_response\\\" numDigits=\\\"1\\\"> \\\n//         <Say voice=\\\"woman\\\">Hello, there is an active alarm at the Conroe Location.  Press 1 to acknowledge and prevent the next operator from being notified.</Say> \\\n//         </Gather> \\\n//         <Say voice=\\\"woman\\\">Sorry, that choice is invalid.</Say> \\\n//     </Response>\"\n      var voiceMsg = flow.get('voiceMsg')\nvar twiml_response = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\" standalone=\\\"yes\\\"?> \\\n    <Response> \\\n      <Gather action=\\\"http://ec2-18-219-204-251.us-east-2.compute.amazonaws.com:1880/operator_response\\\" numDigits=\\\"1\\\"> \\\n        <Say voice=\\\"woman\\\">\"+voiceMsg+\"</Say> \\\n      </Gather> \\\n      <Say voice=\\\"woman\\\">Sorry, I didn't get your response. You can still acknowledge the alarm by texting 9 or a. c. k. to this number. Goodbye.</Say> \\\n    </Response>\";\n\nmsg.payload = twiml_response;\nreturn msg;      \n      \n\n// <Gather action=\\\"http://ec2-18-218-144-146.us-east-2.compute.amazonaws.com:1880/operator_response\\\" numDigits=\\\"1\\\"> \\\n\n    //   </Gather> \\\n    //   <Say voice=\\\"woman\\\">Sorry, that choice is invalid.</Say> \\","outputs":1,"noerr":0,"x":2030.5034866333008,"y":1236.0350551605225,"wires":[["c3e351fd.e983e"]]},{"id":"a0096156.1f92d","type":"function","z":"4f4627ba.0e9948","name":"handleGather","func":"// Use 2 outputs, 2nd is for mqtt topic/payload combination\n// Could be useful to post other caller info to a topic\n// var mqttOut = null;\n// var responseMsg = \"\";\nnode.error('INSIDE GATHER')\n// var name = \"wholehouse\";\n// var reading = context.global[name];\n\nvar twiml_response = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\" standalone=\\\"yes\\\"?> \\\n        <Response><Say voice=\\\"woman\\\"> \\\n\tYou have acknowledged the alarm.  No other operators will be called.  Check text message for alarm details. Goodbye.\\\n</Say>\\\n</Response>\"\nmsg.payload = twiml_response\nflow.set('alarmAcked', true)\nreturn [msg,msg]\n\n","outputs":1,"noerr":0,"x":2037.5269775390625,"y":1313.5741863250732,"wires":[["c3e351fd.e983e"]]},{"id":"975a56b2.c22468","type":"catch","z":"4f4627ba.0e9948","name":"","scope":null,"uncaught":false,"x":1993.7769241333008,"y":1411.4413051605225,"wires":[["a07b4d2e.b0473"]]},{"id":"a07b4d2e.b0473","type":"debug","z":"4f4627ba.0e9948","name":"ERROR","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":2161.034736633301,"y":1408.9803676605225,"wires":[]},{"id":"74e6fe88.1b164","type":"comment","z":"4f4627ba.0e9948","name":"SECOND OUTPUT = VOICE","info":"","x":1703.5270080566406,"y":921.0741653442383,"wires":[]},{"id":"73d8a74f.1724b8","type":"function","z":"4f4627ba.0e9948","name":"SET ALARM CONTACTS","func":"// var contacts = { '+14696512674': 'William Wylie', '+18172473760': 'Mark Cowan' }\n// 4326645113 +14696512674,+18172473760, +14328133806,+14328131895,+14326614092,+14325565341,+14324139363,+14324137920,+14326648765,+14327411885,+14326645113\n// '+15752634941': 'Operator', '+14322084818':'Mr Worcester', '+18172473760':'de Boss', '+13375229291':'who-needs-sleep', '+15757257206':'', '+14326340166':''\nvar contacts = {'+15752634941': 'Operator', '+14322084818':'Mr Worcester', '+18172473760':'de Boss', '+13375229291':'who-needs-sleep', '+15757257206':'', '+14326340166':''}\nflow.set('alarmContacts', contacts)","outputs":1,"noerr":0,"x":2065.026954650879,"y":1496.964708328247,"wires":[[]]},{"id":"6b45c04.0d5834","type":"function","z":"4f4627ba.0e9948","name":"CLEAR ALARM CONTACTS","func":"flow.set('alarmContacts', undefined)","outputs":1,"noerr":0,"x":2071.526924133301,"y":1556.0741176605225,"wires":[[]]},{"id":"7cb20c14.40e9c4","type":"inject","z":"4f4627ba.0e9948","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":1848.5269508361816,"y":1492.0741558074951,"wires":[["73d8a74f.1724b8"]]},{"id":"7b046402.890dac","type":"inject","z":"4f4627ba.0e9948","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1844.5269241333008,"y":1565.0741176605225,"wires":[["6b45c04.0d5834"]]},{"id":"57b356a0.b2c788","type":"http in","z":"4f4627ba.0e9948","name":"Operator Input","url":"/operator_response","method":"post","upload":false,"swaggerDoc":"","x":1751.5271453857422,"y":1307.0741539001465,"wires":[["a0096156.1f92d","5a2ed359.64184c","6057f903.1a4828"]]},{"id":"83eec15f.2fdca","type":"trigger","z":"4f4627ba.0e9948","op1":"","op2":"call_next","op1type":"nul","op2type":"str","duration":"5","extend":true,"units":"min","reset":"","bytopic":"all","name":"","x":1767.035140991211,"y":1101.9573020935059,"wires":[["64a945ac.65ea4c"]]},{"id":"4d358133.83c4","type":"delay","z":"4f4627ba.0e9948","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1884.7850189208984,"y":963.4335289001465,"wires":[["83eec15f.2fdca"]]},{"id":"bb440aeb.8317e8","type":"function","z":"4f4627ba.0e9948","name":"Alarm Acknowledge","func":"\n    var statusMsg = \"Current Time        \" + msg.timeStamp\n   var alarms = flow.get(\"Alarms\")\n   var scadaCommAlarm = flow.get(\"scadaCommAlarm\")||\"Normal\"\n   var updateOtherUsersMsg = null\n   var alarmAcked = flow.get(\"alarmAcked\")||false\n    if(alarms && !alarmAcked) {\n        \n    var activeAlarms = \"\"\n    if(scadaCommAlarm == \"Alarm\") {\n        activeAlarms = \"SCADA Comm Alarm, \"\n    }\n    \n        alarms.forEach(function(a){\n        var name = Object.keys(a)[0]\n        var val = a[name]\n        val = val.toLowerCase()\n        if(val.indexOf(\"alarm\") !== -1) {\n            activeAlarms = activeAlarms + name + \", \"\n        }\n    });\n    if ((activeAlarms.length > 0)) {\n        updateOtherUsersMsg = {\"payload\": {}}\n        updateOtherUsersMsg.payload.To = msg.payload.From\n        // node.error(\"updateOtherUsersMsg\", updateOtherUsersMsg)\n        // node.error(\"updateOtherUsersMsg.payload.To\", updateOtherUsersMsg.payload.To)\n        // node.error(\"updateOtherUsersMsg.payload.From\", updateOtherUsersMsg.payload.From)\n        \n     activeAlarms = activeAlarms.substring(0,activeAlarms.length-2)\n     statusMsg += \"\\nConroe\\nAlarms Acknowledged: \" + activeAlarms  \n     flow.set(\"alarmAcked\", true)\n    } else {\n     statusMsg += \"\\nConroe\\nNo Active Alarms to Acknowledge\"       \n    }\n\n    } else {\n        statusMsg += \"\\nConroe\\nNo Active Alarms to Acknowledge\" \n    }\n    \n    // alarms = flow.get(\"Alarms\")\n    // alarm_names = Object.keys(alarms)\n    // var foundAlarm = false\n    \n    // alarm_names.forEach(function(a){\n\n        \n    // if(alarms)\n    \n    // if(!foundAlarm) {\n    // statusMsg = statusMsg + \"\\n\\nReset Alarms:\"\n    // }    \n    // statusMsg = statusMsg + \"\\nTank High-High Level\"\n    // foundAlarm = true\n        \n        \n        \n    // });\n\n    // if(!foundAlarm) {\n    // statusMsg = statusMsg + \"  There were no alarms to reset.\"\n    // }\n\n  msg.payload = statusMsg\n  if(updateOtherUsersMsg) {\n     return [msg, updateOtherUsersMsg]; \n  } else {\n      return [msg];\n  }\n  \n\n","outputs":2,"noerr":0,"x":1266.5230712890625,"y":230.03905487060547,"wires":[["1d10c513.ad278b"],["6057f903.1a4828"]]},{"id":"5a2ed359.64184c","type":"debug","z":"4f4627ba.0e9948","name":"OEPRATOR","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1838.523048400879,"y":1376.5390491485596,"wires":[]},{"id":"6057f903.1a4828","type":"function","z":"4f4627ba.0e9948","name":"send ack text message to other users","func":"node.error(\"SEND ACK TEXT MESSAGE FUNCTION\")\nvar users = flow.get('alarmContacts')\nvar nums = Object.keys(users)\nnode.error(\"MSG PAYLOAD TO\")\nnode.error(msg.payload.To)\nvar idx = nums.indexOf(msg.payload.To)\nvar userName = users[nums[idx]]\nnums.splice(idx,1)\nvar activeAlarms = \"\"\nvar count = 0\nvar alarms = flow.get(\"Alarms\")\nvar scadaCommAlarm = flow.get(\"scadaCommAlarm\")||\"Normal\"\nif(scadaCommAlarm == \"Alarm\") {\n    activeAlarms += \"SCADA Comm Alarm, \"\n    count += 1\n}\n\n\nnode.error(\"BEFORE LOOP\")\n    alarms.forEach(function(a){\n        var name = Object.keys(a)[0]\n        var val = a[name]\n        val = val.toLowerCase()\n        if(val.indexOf(\"alarm\") !== -1) {\n            activeAlarms += name + \", \"\n            count += 1\n        }\n    });\n    activeAlarms = activeAlarms.substring(0,activeAlarms.length-2)\nnode.error(\"AFTER LOOP\")\nif(count > 1) {\nvar msg = \"The alarms: \" + activeAlarms + \" were acknowledged by: \" + userName    \n} else {\nvar msg = \"The alarm: \" + activeAlarms + \" was acknowledged by: \" + userName    \n}\n\nvar n = \"\"\nnums.forEach(function(num){\n   n = n + num + \",\" \n});\nn = n.substring(0,n.length-1)\nvar obj = {\"payload\": msg, \"topic\": n, \"reset\": true}\nnode.error(obj)\nreturn obj","outputs":1,"noerr":0,"x":1368.5231857299805,"y":1135.5391130447388,"wires":[["83eec15f.2fdca"]]},{"id":"1e81244a.d1a53c","type":"sms","z":"4f4627ba.0e9948","name":"Customer Twilio","message":"","numbers":"+14325994522","throttle":"5000","twilio":"d2d1963f.98df78","x":2024,"y":162,"wires":[[]]},{"id":"f6c8f009.0ff57","type":"inject","z":"4f4627ba.0e9948","name":"","topic":"","payload":"Hello, this is the Hannathon Conroe Callout Alarm Number.  SMS alarms will come from this. You can text this number '1' for site status, '2' to reset alarms, '3' for setpoints, '4' for Tank Levels, '9' to acknowledge alarms.  If you are receiving this in error or need help, please contact Mark Cowan 8172473760 or Will Wylie 4695822274 #0.  Text 'STOP' to stop messages and 'START' to start messages if they were previously stopped.","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":657.7808570861816,"y":970.9609832763672,"wires":[[]]},{"id":"8e75c435.623048","type":"mqtt out","z":"4f4627ba.0e9948","name":"Castaway Compression","topic":"Castaway 6 Compressor","qos":"1","retain":"","broker":"5e2578b5.524f98","x":731.4996109008789,"y":1064.9999866485596,"wires":[]},{"id":"8d862694.f3e2f8","type":"comment","z":"4f4627ba.0e9948","name":"SCADA HEALTH MANAGER MQTT KEEPALIVE","info":"","x":755.4996109008789,"y":1023.9999866485596,"wires":[]},{"id":"44a7de8f.63d4","type":"cron","z":"4f4627ba.0e9948","name":"","crontab":"0 */3 * * * *","x":465.4996109008789,"y":218.99998664855957,"wires":[["d70067a.67e3498"]]},{"id":"a56888d8.ecbff8","type":"comment","z":"4f4627ba.0e9948","name":"REFRESH points every 3 minutes","info":"","x":730,"y":220,"wires":[]},{"id":"e5d2b808.556a68","type":"function","z":"4f4627ba.0e9948","name":"Comm Status Cache","func":"var m = \"Current Time        \" + msg.timeStamp\nm += \"\\nCastaway 6 Compressor\\n\"\n\nvar scadaCommAlarm = flow.get(\"scadaCommAlarm\")\n\n        \n        flow.set(\"scadaCommAlarmDate\", msg.timeStamp)\n        m += \"Alarm Cleared:  SCADA Communication Now Online\"\n        msg.payload = m\n        msg.reset = true\n        return msg\n","outputs":1,"noerr":0,"x":1140,"y":420,"wires":[["13b1cde6.a0bdd2","21cb7f8c.ab6da","5b3b101d.cdcb6"]]},{"id":"69252053.d53ca","type":"inject","z":"4f4627ba.0e9948","name":"SEND SCADA COMM ALM CLEAR","topic":"","payload":"good","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":893.4996147155762,"y":347.99996757507324,"wires":[["fb655aef.29a448"]]},{"id":"fb655aef.29a448","type":"moment","z":"4f4627ba.0e9948","name":"Inject timeStamp","topic":"","input":"","inputType":"date","inTz":"America/Chicago","adjAmount":0,"adjType":"days","adjDir":"add","format":"MM/DD/YY hh:mm A","locale":"POSIX","output":"timeStamp","outputType":"msg","outTz":"America/Chicago","x":895.9996166229248,"y":412.99997901916504,"wires":[["e5d2b808.556a68"]]},{"id":"af94847b.f9db28","type":"sms","z":"4f4627ba.0e9948","name":"Customer Twilio","message":"","numbers":"+15752634941, +14322084818, +18172473760, +13375229291, +15757257206, +14326340166","throttle":"5000","twilio":"d2d1963f.98df78","x":2220,"y":220,"wires":[[]]},{"id":"91b11b2a.18d978","type":"inject","z":"4f4627ba.0e9948","name":"","topic":"status","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":520,"y":740,"wires":[["c296b46c.1d97b8"]]},{"id":"489c73f4.663c3c","type":"inject","z":"4f4627ba.0e9948","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"onceDelay":0.1,"x":190,"y":1300,"wires":[["fecb3328.6b6b3"]]},{"id":"fecb3328.6b6b3","type":"function","z":"4f4627ba.0e9948","name":"CLEAR CACHE","func":"flow.set(\"Flow\", undefined)\nflow.set(\"Levels\", undefined)\nflow.set(\"Other\", undefined)\nflow.set(\"Status\", undefined)\nflow.set(\"Alarms\", undefined)\nflow.set(\"Setpoints\", undefined)","outputs":1,"noerr":0,"x":376.50000381469727,"y":1304.890552520752,"wires":[[]]},{"id":"5862bcfb.450634","type":"inject","z":"4f4627ba.0e9948","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1680,"y":140,"wires":[["b45641ac.874e9"]]},{"id":"dba0fbfc.9077b8","type":"function","z":"4f4627ba.0e9948","name":"Send ESD","func":"var statusMsg = \"Current Time        \" + msg.timeStamp\n    statusMsg += \"\\nCastaway 6\\nTesting email spam filter text scooter if received\"\n    \n    // alarms = flow.get(\"Alarms\")\n    // alarm_names = Object.keys(alarms)\n    // var foundAlarm = false\n    \n    // alarm_names.forEach(function(a){\n\n        \n    // if(alarms)\n    \n    // if(!foundAlarm) {\n    // statusMsg = statusMsg + \"\\n\\nReset Alarms:\"\n    // }    \n    // statusMsg = statusMsg + \"\\nTank High-High Level\"\n    // foundAlarm = true\n        \n        \n        \n    // });\n\n    // if(!foundAlarm) {\n    // statusMsg = statusMsg + \"  There were no alarms to reset.\"\n    // }\n \n  msg.payload = statusMsg\n  var subj = \"Compressor Alarms\"\n  msg.topic = subj\n  return msg;\n  \n\n","outputs":1,"noerr":0,"x":1560,"y":220,"wires":[[]]},{"id":"6f8ef3e0.6e48ec","type":"inject","z":"4f4627ba.0e9948","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":1500,"y":160,"wires":[["dba0fbfc.9077b8"]]},{"id":"3c637bd3.384a04","type":"sendgrid","z":"4f4627ba.0e9948","from":"Notify@cownconsultingservices.com","to":"5752634941@vtext.com","name":"","content":"text","x":2020,"y":380,"wires":[]},{"id":"66fc2f.c42803d","type":"sendgrid","z":"4f4627ba.0e9948","from":"Notify@cowanconsultingservices.com","to":"scooter@cowanconsultingservices.com","name":"Scooter","content":"text","x":1590,"y":840,"wires":[]},{"id":"104cbf43.0f3561","type":"sendgrid","z":"4f4627ba.0e9948","from":"Notify@cowanconsultingservices.com","to":"willyw@cowanconsultingservices.com","name":"Willy W.","content":"text","x":1716,"y":882,"wires":[]},{"id":"7c4945dd.5479cc","type":"delay","z":"4f4627ba.0e9948","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1608,"y":738,"wires":[["66fc2f.c42803d","2e61e427.87c77c","5b3b101d.cdcb6"]]},{"id":"9a4235db.5fbc38","type":"sendgrid","z":"4f4627ba.0e9948","from":"Notify@cowanconsultingservices.com","to":" lgardea@gafab.co","name":"lupe","content":"text","x":2090,"y":440,"wires":[]},{"id":"1fc33077.189be","type":"sendgrid","z":"4f4627ba.0e9948","from":"Notify@cowanconsultingservices.com","to":"will@gafab.co","name":"will h","content":"text","x":2090,"y":500,"wires":[]},{"id":"a5f12324.6eb59","type":"trigger","z":"4f4627ba.0e9948","op1":"","op2":"","op1type":"pay","op2type":"payl","duration":"8","extend":true,"units":"min","reset":"","bytopic":"all","name":"only send first and last alarms of a sequence ","x":1646,"y":396,"wires":[["627dff00.2244d","3c637bd3.384a04","9a4235db.5fbc38","1fc33077.189be"]]},{"id":"13b1cde6.a0bdd2","type":"trigger","z":"4f4627ba.0e9948","op1":"","op2":"","op1type":"pay","op2type":"payl","duration":"1","extend":false,"units":"min","reset":"","bytopic":"all","name":"comms alarms","x":1628,"y":324,"wires":[["627dff00.2244d","3c637bd3.384a04","9a4235db.5fbc38","1fc33077.189be"]]},{"id":"2e61e427.87c77c","type":"sendgrid","z":"4f4627ba.0e9948","from":"Notify@cowanconsultingservices.com","to":"raul@cowanconsultingservices.com","name":"Ral","content":"text","x":1580,"y":882,"wires":[]},{"id":"21cb7f8c.ab6da","type":"trigger","z":"4f4627ba.0e9948","op1":"","op2":"","op1type":"pay","op2type":"payl","duration":"30","extend":true,"units":"min","reset":"","bytopic":"all","name":"comms alarms","x":1628,"y":576,"wires":[["7c4945dd.5479cc","5b3b101d.cdcb6"]]},{"id":"5b3b101d.cdcb6","type":"debug","z":"4f4627ba.0e9948","name":"msg terst","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1932,"y":792,"wires":[]}]