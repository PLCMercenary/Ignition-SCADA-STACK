"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};module.exports=function(p){require("source-map-support").install();var g=require("./core/opcua-iiot-core-method");p.nodes.registerType("OPCUA-IIoT-Method-Caller",function(e){p.nodes.createNode(this,e),this.objectId=e.objectId,this.methodId=e.methodId,this.methodType=e.methodType,this.value=e.value,this.justValue=e.justValue,this.name=e.name,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.inputArguments=e.inputArguments,this.connector=p.nodes.getNode(e.connector);var h=this;if(h.reconnectTimeout=1e3,h.sessionTimeout=null,h.verboseLog=function(e){p.settings.verbose&&g.internalDebugLog(e)},h.statusLog=function(e){p.settings.verbose&&h.showStatusActivities&&h.verboseLog("Status: "+e)},h.setNodeStatusTo=function(e){h.statusLog(e);var t=g.core.getNodeStatus(e,h.showStatusActivities);h.status({fill:t.fill,shape:t.shape,text:t.status})},h.handleMethodError=function(e,t){g.internalDebugLog(e),h.showErrors&&h.error(e,t),g.core.isSessionBad(e)&&h.connector.resetBadSession()},h.handleMethodWarn=function(e){h.showErrors&&h.warn(e),g.internalDebugLog(e)},h.on("input",function(e){var t=e;if(t.objectId=e.payload.objectId||h.objectId,t.methodId=e.payload.methodId||h.methodId,t.methodType=e.payload.methodType||h.methodType,t.inputArguments=e.payload.inputArguments||h.inputArguments,t.nodetype="method",t.objectId)if(t.methodId)if(t.inputArguments){if(t.methodType)return"OPEN"!==h.connector.stateMachine.getMachineState()?(g.writeDebugLog("Client State Not Open On Write"),void(h.showErrors&&h.error(new Error("Client Not Open On Wirte"),e))):void(h.opcuaSession?h.callMethodOnSession(t):h.handleMethodWarn("Session Not Ready For Method Call"));h.handleMethodWarn("No Method Type Found For Method Call")}else h.handleMethodWarn("No Input Arguments Found For Method Call");else h.handleMethodWarn("No Method-Id Found For Method Call");else h.handleMethodWarn("No Object-Id Found For Method Call")}),h.callMethodOnSession=function(t){t.methodId&&t.inputArguments?g.getArgumentDefinition(h.opcuaSession,t).then(function(e){g.detailDebugLog("Call Argument Definition Results: "+JSON.stringify(e)),h.callMethod(t,e)}).catch(h.handleMethodError):g.internalDebugLog(new Error("No Method Id And/Or Parameters"))},h.callMethod=function(c,l){g.callMethods(h.opcuaSession,c).then(function(e){g.detailDebugLog("Methods Call Results: "+JSON.stringify(e));var t=null,o=[],n=e.msg;n.nodetype="method",n.methodType=e.msg.methodType;var r=!0,s=!1,i=void 0;try{for(var a,u=e.results[Symbol.iterator]();!(r=(a=u.next()).done);r=!0)t=a.value,o.push({statusCode:t.statusCode,outputArguments:t.outputArguments})}catch(e){s=!0,i=e}finally{try{!r&&u.return&&u.return()}finally{if(s)throw i}}var d={};h.justValue?(n.inputArguments&&delete n.inputArguments,d=JSON.stringify(o,null,2)):d=JSON.stringify({results:e.results,definition:l},null,2);try{p.util.setMessageProperty(n,"payload",JSON.parse(d))}catch(e){h.showErrors&&(h.warn("JSON not to parse from string for dataValues type "+("undefined"==typeof readResult?"undefined":_typeof(readResult))),h.error(e,c)),n.payload=d,n.error=e.message}h.send(n)}).catch(function(e){g.internalDebugLog(e),h.showErrors&&h.error(e,c)})},h.setOPCUAConnected=function(e){h.opcuaClient=e,h.setNodeStatusTo("connected")},h.opcuaSessionStarted=function(e){h.opcuaSession=e,h.setNodeStatusTo("active")},h.connectorShutdown=function(e){g.internalDebugLog("Connector Shutdown"),e&&(h.opcuaClient=e)},!h.connector)throw new TypeError("Connector Not Valid");h.connector.on("connected",h.setOPCUAConnected),h.connector.on("session_started",h.opcuaSessionStarted),h.connector.on("after_reconnection",h.connectorShutdown),g.core.setNodeInitalState(h.connector.stateMachine.getMachineState(),h)})};
//# sourceMappingURL=maps/opcua-iiot-method-caller.js.map
