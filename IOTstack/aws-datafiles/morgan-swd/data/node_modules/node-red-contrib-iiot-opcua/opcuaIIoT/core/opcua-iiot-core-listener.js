"use strict";require("source-map-support").install();var de=de||{biancoroyal:{opcua:{iiot:{core:{listener:{}}}}}};de.biancoroyal.opcua.iiot.core.listener.core=de.biancoroyal.opcua.iiot.core.listener.core||require("./opcua-iiot-core"),de.biancoroyal.opcua.iiot.core.listener.client=de.biancoroyal.opcua.iiot.core.listener.client||require("./opcua-iiot-core-client"),de.biancoroyal.opcua.iiot.core.listener.internalDebugLog=de.biancoroyal.opcua.iiot.core.listener.internalDebugLog||require("debug")("opcuaIIoT:listener"),de.biancoroyal.opcua.iiot.core.listener.detailDebugLog=de.biancoroyal.opcua.iiot.core.listener.detailDebugLog||require("debug")("opcuaIIoT:listener:details"),de.biancoroyal.opcua.iiot.core.listener.subscribeDebugLog=de.biancoroyal.opcua.iiot.core.listener.subscribeDebugLog||require("debug")("opcuaIIoT:listener:subscribe"),de.biancoroyal.opcua.iiot.core.listener.subscribeDetailDebugLog=de.biancoroyal.opcua.iiot.core.listener.subscribeDetailDebugLog||require("debug")("opcuaIIoT:listener:subscribe:details"),de.biancoroyal.opcua.iiot.core.listener.eventDebugLog=de.biancoroyal.opcua.iiot.core.listener.eventDebugLog||require("debug")("opcuaIIoT:listener:event"),de.biancoroyal.opcua.iiot.core.listener.eventDetailDebugLog=de.biancoroyal.opcua.iiot.core.listener.eventDetailDebugLog||require("debug")("opcuaIIoT:listener:event:details"),de.biancoroyal.opcua.iiot.core.listener.SUBSCRIBE_DEFAULT_INTERVAL=1e3,de.biancoroyal.opcua.iiot.core.listener.MIN_LISTENER_INTERVAL=100,de.biancoroyal.opcua.iiot.core.listener.MAX_LISTENER_INTERVAL=36e5,de.biancoroyal.opcua.iiot.core.listener.SUBSCRIBE_DEFAULT_QUEUE_SIZE=1,de.biancoroyal.opcua.iiot.core.listener.EVENT_DEFAULT_INTERVAL=250,de.biancoroyal.opcua.iiot.core.listener.EVENT_DEFAULT_QUEUE_SIZE=1e4,de.biancoroyal.opcua.iiot.core.listener.getEventSubscribtionParameters=function(e){return{requestedPublishingInterval:e||100,requestedLifetimeCount:60,requestedMaxKeepAliveCount:10,maxNotificationsPerPublish:4,publishingEnabled:!0,priority:1}},de.biancoroyal.opcua.iiot.core.listener.getSubscriptionParameters=function(e){return{requestedPublishingInterval:e||100,requestedLifetimeCount:1e3,requestedMaxKeepAliveCount:12,maxNotificationsPerPublish:100,publishingEnabled:!0,priority:10}},de.biancoroyal.opcua.iiot.core.listener.collectAlarmFields=function(e,o,i){var t={};switch(e){case"EventId":t.eventId=i;break;case"EventType":t.eventType=i;break;case"SourceNode":t.sourceNode=i;break;case"SourceName":t.sourceName=i;break;case"Time":t.time=i;break;case"ReceiveTime":t.receiveTime=i;break;case"Message":t.message=i.text;break;case"Severity":t.severity=i;break;case"ConditionClassId":t.conditionClassId=i;break;case"ConditionClassName":t.conditionClassName=i;break;case"ConditionName":t.conditionName=i;break;case"BranchId":t.branchId=i;break;case"Retain":t.retain=i;break;case"EnabledState":t.enabledState=i.text;break;case"Quality":t.quality=i;break;case"LastSeverity":t.lastSeverity=i;break;case"Comment":t.comment=i.text;break;case"ClientUserId":t.clientUserId=i;break;case"AckedState":t.ackedState=i.text;break;case"ConfirmedState":t.confirmedState=i.text;break;case"ActiveState":t.activeState=i.text;break;case"InputNode":t.inputNode=i;break;case"SupressedState":t.supressedState=i.text;break;case"HighHighLimit":t.highHighLimit=i;break;case"HighLimit":t.highLimit=i;break;case"LowLimit":t.lowLimit=i;break;case"LowLowLimit":t.lowLowLimit=i;break;case"Value":t.value=i;break;default:t.field={},t.field.name=e,(t.field.value=i).text&&(t.field.value.text=i.text)}return t},de.biancoroyal.opcua.iiot.core.listener.getBasicEventFields=function(){return["EventId","SourceName","Message","ReceiveTime"]},de.biancoroyal.opcua.iiot.core.listener.getAllEventFields=function(){return["ConditionName","ConditionType","ConditionClassId","ConditionClassName","ConditionVariableType","SourceNode","BranchId","EventType","Severity","Retain","Comment","Comment.SourceTimestamp","EnabledState","EnabledState.Id","EnabledState.EffectiveDisplayName","EnabledState.TransitionTime","LastSeverity","LastSeverity.SourceTimestamp","Quality","Quality.SourceTimestamp","Time","ClientUserId","AckedState","AckedState.Id","ConfirmedState","ConfirmedState.Id","LimitState","LimitState.Id","ActiveState","ActiveState.Id"]},de.biancoroyal.opcua.iiot.core.listener.getStateFields=function(){return["ConditionName","SourceNode","Quality","Time","EnabledState","EnabledState.Id","EnabledState.EffectiveDisplayName","EnabledState.TransitionTime","AckedState","AckedState.Id","ConfirmedState","ConfirmedState.Id","LimitState","LimitState.Id","ActiveState","ActiveState.Id"]},de.biancoroyal.opcua.iiot.core.listener.getConditionFields=function(){return["Time","Quality","BranchId","SourceNode","ConditionName","ConditionType","ConditionClassId","ConditionClassName","ConditionVariableType"]},de.biancoroyal.opcua.iiot.core.listener.buildNewMonitoredItem=function(a,r,n){var c=de.biancoroyal.opcua.iiot.core.listener;return new Promise(function(i,t){a||t(new Error("NodeId Is Not Valid"));var e=void 0,o=void 0;e="number"==typeof r.payload.interval&&r.payload.interval<=c.MAX_LISTENER_INTERVAL&&r.payload.interval>=c.MIN_LISTENER_INTERVAL?parseInt(r.payload.interval):c.SUBSCRIBE_DEFAULT_INTERVAL,o=r.payload.queueSize&&"number"==typeof r.payload.queueSize?parseInt(r.payload.queueSize):c.SUBSCRIBE_DEFAULT_QUEUE_SIZE,n.monitor({nodeId:c.core.nodeOPCUA.resolveNodeId(a),attributeId:c.core.nodeOPCUA.AttributeIds.Value},{samplingInterval:e,discardOldest:!0,queueSize:o},c.core.nodeOPCUA.read_service.TimestampsToReturn.Both,function(e,o){e?(c.internalDebugLog("subscribing monitored item "+e),t(e)):i({nodeId:a,monitoredItem:o})})})},de.biancoroyal.opcua.iiot.core.listener.buildNewEventItem=function(a,r,n){var c=de.biancoroyal.opcua.iiot.core.listener;return new Promise(function(i,t){a||t(new Error("NodeId Is Not Valid"));var e=void 0,o=void 0;e="number"==typeof r.payload.interval&&r.payload.interval<c.MAX_LISTENER_INTERVAL?parseInt(r.payload.interval):c.EVENT_DEFAULT_INTERVAL,o="number"==typeof r.payload.queueSize?parseInt(r.payload.queueSize):c.EVENT_DEFAULT_QUEUE_SIZE,n.monitor({nodeId:c.core.nodeOPCUA.resolveNodeId(a),attributeId:c.core.nodeOPCUA.AttributeIds.EventNotifier},{samplingInterval:e,discardOldest:!0,queueSize:o,filter:r.payload.eventFilter},c.core.nodeOPCUA.read_service.TimestampsToReturn.Both,function(e,o){e?(c.internalDebugLog("subscribing event item "+e),t(e)):i({nodeId:a,monitoredItem:o})})})},de.biancoroyal.opcua.iiot.core.listener.getAllEventTypes=function(o){return new Promise(function(t,a){o||a(new Error("Session Is Not Valid To Browse For Event Types"));var r=[],e=[{nodeId:(0,this.core.nodeOPCUA.makeNodeId)(this.core.nodeOPCUA.ObjectTypeIds.BaseEventType),referenceTypeId:this.core.nodeOPCUA.resolveNodeId("HasSubtype"),browseDirection:this.core.nodeOPCUA.BrowseDirection.Forward,includeSubtypes:!0,nodeClassMask:this.core.nodeOPCUA.NodeClassMask.ObjectType,resultMask:63}];o.browse(e,function(e,o,i){e?a(e):(o&&(0<o.length?o[0].references.forEach(function(e){r.push({displayName:e.displayName.text,nodeId:e.nodeId,reference:e})}):o.references&&o.references.forEach(function(e){r.push({displayName:e.displayName.text,nodeId:e.nodeId,reference:e})})),t(r))})})},de.biancoroyal.opcua.iiot.core.listener.analyzeEvent=function(n,c,s){var d=de.biancoroyal.opcua.iiot.core.listener.core,l=de.biancoroyal.opcua.iiot.core.listener;return new Promise(function(e,t){if(n||t(new Error("Session Is Not Valid To Analyze Event")),c&&"function"==typeof c||t(new Error("BrowseForBrowseName Is Not Valid Function")),s){var o=0,a={},r=[];s.forEach(function(i){l.eventDebugLog("variant entry: "+i.toString());try{i.dataType&&i.value&&(a=l.collectAlarmFields(s.monitoringParameters.filter.selectClauses[o],i.dataType.key.toString(),i.value),i.dataType===d.nodeOPCUA.DataType.NodeId?c(n,i.value,function(e,o){e?t(e):(a.browseName=o,r.push({eventInformation:a,eventData:i.toJSON()}))}):r.push({eventInformation:a,eventData:i.toJSON()})),o++}catch(e){a={error:e},r.push({eventInformation:a,eventData:i.toJSON()})}}),e(r)}else t(new Error("Event Response Not Valid"))})},module.exports=de.biancoroyal.opcua.iiot.core.listener;
//# sourceMappingURL=../maps/core/opcua-iiot-core-listener.js.map
