"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};module.exports=function(s){require("source-map-support").install();var m=require("./core/opcua-iiot-core-listener"),t=require("collections/map");s.nodes.registerType("OPCUA-IIoT-Listener",function(e){s.nodes.createNode(this,e),this.action=e.action,this.queueSize=e.queueSize||1,this.name=e.name,this.justValue=e.justValue,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.connector=s.nodes.getNode(e.connector);var u=this;u.reconnectTimeout=1e3,u.sessionTimeout=null,u.opcuaClient=null,u.opcuaSession=null,u.subscriptionStarted=!1;var c=null,i=m.core.nodeOPCUA.StatusCodes,o=m.core.nodeOPCUA.AttributeIds;if(u.monitoredItems=new t,u.monitoredASO=new t,u.verboseLog=function(e){s.settings.verbose&&m.internalDebugLog(e)},u.statusLog=function(e){s.settings.verbose&&u.showStatusActivities&&u.verboseLog("Status: "+e)},u.setNodeStatusTo=function(e){u.statusLog(e);var t=m.core.getNodeStatus(e,u.showStatusActivities);u.status({fill:t.fill,shape:t.shape,text:t.status})},u.createSubscription=function(e,t){var o="number"==typeof e.payload?e.payload:null;c=null,u.subscriptionStarting=!0;var n={};"events"!==u.action?(m.internalDebugLog("create monitoring subscription"),n=e.payload.options||m.getSubscriptionParameters(o)):(m.internalDebugLog("create event subscription"),n=e.payload.options||m.getEventSubscribtionParameters(o)),u.makeSubscription(n,t)},u.resetSubscription=function(){u.subscriptionStarting=!1,u.sendAllMonitoredItems("SUBSCRIPTION TERMINATED")},u.sendAllMonitoredItems=function(e){var o=[];u.monitoredASO.forEach(function(e,t){o.push({name:"",nodeId:t,datatypeName:""})}),u.send({payload:e,monitoredASO:u.monitoredASO,addressSpaceItems:o}),u.monitoredItems.clear(),u.monitoredASO.clear()},u.subscribeActionInput=function(e){c?u.subscribingPreCheck()?u.subscribeMonitoredItem(e):u.resetSubscription():u.createSubscription(e,function(){u.subscribeMonitoredItem(e)})},u.subscribeEventsInput=function(e){c?u.subscribingPreCheck()?u.subscribeMonitoredEvent(e):u.resetSubscription():u.createSubscription(e,function(){u.subscribeMonitoredEvent(e)})},u.subscribingPreCheck=function(){return c&&"string"!=typeof c.subscriptionId},u.updateSubscriptionStatus=function(){m.internalDebugLog("listening ("+u.monitoredItems.length+")"),u.setNodeStatusTo("listening ("+u.monitoredItems.length+")")},u.subscribeMonitoredItem=function(o){if(u.subscriptionStarted){var n=null,e=!0,t=!1,r=void 0;try{for(var i,s=function(){if(!(n=i.value).nodeId)return m.subscribeDebugLog("Address Space Item Not Valid to Monitor "+n),{v:void 0};if("ns=0;i=0"===n.datatypeName)return m.subscribeDebugLog("Address Space Item Not Allowed to Monitor "+n),{v:void 0};var t=u.monitoredASO.get(n.nodeId.toString());t?(m.subscribeDebugLog("Monitored Item Unsubscribe "+n.nodeId),t.terminate(function(e){u.monitoredItemTerminated(o,t,n.nodeId,e)})):(m.subscribeDebugLog("Monitored Item Subscribing "+n.nodeId),m.buildNewMonitoredItem(n.nodeId,o,c).then(function(e){m.subscribeDebugLog("Monitored Item Subscribed Id:"+e.monitoredItem.monitoredItemId+" to "+e.nodeId),u.monitoredASO.set(e.nodeId.toString(),e.monitoredItem)}).catch(function(e){m.subscribeDebugLog(e),u.showErrors&&u.error(e,o)}))},d=o.addressSpaceItems[Symbol.iterator]();!(e=(i=d.next()).done);e=!0){var a=s();if("object"===(void 0===a?"undefined":_typeof(a)))return a.v}}catch(e){t=!0,r=e}finally{try{!e&&d.return&&d.return()}finally{if(t)throw r}}}else u.error(new Error("Subscription Not Started To Monitor"),o)},u.subscribeMonitoredEvent=function(o){if(u.subscriptionStarted){var n=null,e=!0,t=!1,r=void 0;try{for(var i,s=function(){if(!(n=i.value).nodeId)return m.eventDebugLog("Address Space Item Not Valid to Monitor Event Of "+n),{v:void 0};if("ns=0;i=0"===n.datatypeName)return m.subscribeDebugLog("Address Space Item Not Allowed to Monitor "+n),{v:void 0};var t=u.monitoredASO.get(n.nodeId.toString());t?(m.subscribeDebugLog("Terminate Event Item"+n.nodeId),t.terminate(function(e){u.monitoredItemTerminated(o,t,n.nodeId,e)})):(m.eventDebugLog("Regsiter Event Item "+n.nodeId),m.buildNewEventItem(n.nodeId,o,c).then(function(e){m.eventDebugLog("Event Item Regsitered "+e.monitoredItem.monitoredItemId+" to "+e.nodeId),u.monitoredASO.set(e.nodeId.toString(),e.monitoredItem)}).catch(function(e){m.eventDebugLog(e),u.showErrors&&u.error(e,o)}))},d=o.addressSpaceItems[Symbol.iterator]();!(e=(i=d.next()).done);e=!0){var a=s();if("object"===(void 0===a?"undefined":_typeof(a)))return a.v}}catch(e){t=!0,r=e}finally{try{!e&&d.return&&d.return()}finally{if(t)throw r}}}else u.error(new Error("Subscription Not Started To Monitor"),o)},u.monitoredItemTerminated=function(e,t,o,n){n&&(m.internalDebugLog(n+" on "+t.monitoredItemId),u.showErrors&&u.error(n,e)),u.updateMonitoredItemLists(t,o)},u.updateMonitoredItemLists=function(n,e){n&&n.itemToMonitor&&(u.monitoredItems.has(n.monitoredItemId)&&u.monitoredItems.delete(n.monitoredItemId),m.core.isNodeId(n.itemToMonitor.nodeId)?(m.internalDebugLog("Terminate Monitored Item "+n.itemToMonitor.nodeId),u.monitoredASO.has(e.toString())&&u.monitoredASO.delete(e.toString())):(m.internalDebugLog("monitoredItem NodeId is not valid Id:"+n.monitoredItemId),u.monitoredASO.forEach(function(e,t,o){m.internalDebugLog("monitoredItem removing from ASO list key:"+t+" value "+e.monitoredItemId),e.monitoredItemId&&e.monitoredItemId===n.monitoredItemId&&(m.internalDebugLog("monitoredItem removed from ASO list"+t),o.delete(t))})),u.updateSubscriptionStatus())},u.setMonitoring=function(t){m.core.isNodeId(t.itemToMonitor.nodeId)||m.internalDebugLog("monitoredItem NodeId is not valid Id:"+t.monitoredItemId),m.internalDebugLog("add monitoredItem to list"),u.monitoredItems.set(t.monitoredItemId,t),t.on("changed",function(e){t.monitoringParameters.filter?u.sendDataFromEvent(t,e):u.sendDataFromMonitoredItem(t,e)}),t.on("error",function(e){m.internalDebugLog(e+" on "+t.monitoredItemId),u.showErrors&&u.error(e,{payload:"Monitored Item Error",monitoredItem:t}),u.updateMonitoredItemLists(t,t.itemToMonitor.nodeId),e.message&&e.message.includes("BadSession")&&(u.sendAllMonitoredItems("BAD SESSION"),u.connector.resetBadSession())}),t.on("terminated",function(){m.internalDebugLog("Terminated For "+t.monitoredItemId),u.updateMonitoredItemLists(t,t.itemToMonitor.nodeId)})},u.sendDataFromMonitoredItem=function(e,t){var o={payload:{},topic:u.topic,addressSpaceItems:[{name:"",nodeId:m.core.isNodeId(e.itemToMonitor.nodeId)?e.itemToMonitor.nodeId.toString():"invalid",datatypeName:""}],nodetype:"listen",injectType:"subscribe"},n={};if(u.justValue){n=JSON.stringify(t,null,2);try{s.util.setMessageProperty(o,"payload",JSON.parse(n))}catch(e){u.showErrors&&(u.warn("JSON not to parse from string for monitored item"),u.error(e,o)),o.payload=n,o.error=e.message}}else o.payload={dataValue:t,monitoredItem:e};m.detailDebugLog("sendDataFromMonitoredItem: "+o),u.send(o)},u.sendDataFromEvent=function(o,n){var r={payload:{},topic:u.topic,addressSpaceItems:[{name:"",nodeId:m.core.isNodeId(o.itemToMonitor.nodeId)?o.itemToMonitor.nodeId.toString():"invalid",datatypeName:""}],nodetype:"listen",injectType:"event"};m.analyzeEvent(u.opcuaSession,u.getBrowseName,n).then(function(e){m.eventDetailDebugLog("Monitored Event Results "+e);var t={};if(u.justValue){t=JSON.stringify({dataValue:n},null,2);try{s.util.setMessageProperty(r,"payload",JSON.parse(t))}catch(e){u.showErrors&&(u.warn("JSON not to parse from string for monitored item"),u.error(e,r)),r.payload=t,r.error=e.message}}else r.payload={dataValue:n,eventResults:e,monitoredItem:o};m.detailDebugLog("sendDataFromEvent: "+r),u.send(r)}).catch(function(e){u.errorHandling(e)})},u.errorHandling=function(e){m.internalDebugLog(e),u.showErrors&&u.error(e,{payload:"Error Handling"}),e&&m.core.isSessionBad(e)&&(u.sendAllMonitoredItems("BAD SESSION"),u.connector.resetBadSession())},u.makeSubscription=function(e,t){u.opcuaSession?e?(m.internalDebugLog("Subscription Parameters: "+e),c=new m.core.nodeOPCUA.ClientSubscription(u.opcuaSession,e),m.internalDebugLog("New Subscription Created"),c.on("initialized",function(){m.internalDebugLog("Subscription initialized"),u.subscriptionStarting=!0,u.setNodeStatusTo("initialized")}),c.on("started",function(){m.internalDebugLog("Subscription started"),u.setNodeStatusTo("started"),u.monitoredItems.clear(),u.subscriptionStarting=!1,u.subscriptionStarted=!0,t()}),c.on("terminated",function(){m.internalDebugLog("Subscription terminated"),u.subscriptionStarting=!1,u.subscriptionStarted=!1,u.setNodeStatusTo("terminated"),u.resetSubscription()}),c.on("internal_error",function(e){u.subscriptionStarted=!1,m.internalDebugLog(e),u.showErrors&&u.error(e,{payload:"Internal Error"}),u.setNodeStatusTo("error"),u.resetSubscription()}),c.on("item_added",function(e){u.setMonitoring(e),u.updateSubscriptionStatus()})):m.internalDebugLog("Subscription Parameters Not Valid"):m.internalDebugLog("Subscription Session Not Valid")},u.getBrowseName=function(e,t,r){m.client.read(e,[{nodeId:t,attributeId:o.BrowseName}],function(e,t,o){if(!e&&o[0].statusCode===i.Good){var n=o[0].value.value.name;return r(null,n)}r(e,"Unknown")})},u.on("input",function(e){if("browse"===e.nodetype&&(e.nodetype="inject",e.injectType="listen",e.addressSpaceItems=m.core.buildNodesToListen(e)),!e.addressSpaceItems||!e.addressSpaceItems.length)return m.subscribeDebugLog("Address-Space-Item Set Not Valid"),void(u.showErrors&&u.error(new Error("Address-Space-Item Set Not Valid"),e));if("OPEN"!==u.connector.stateMachine.getMachineState())return m.internalDebugLog("Client State Not Open On Browse"),void(u.showErrors&&u.error(new Error("Client Not Open On Browse"),e));if(!u.opcuaSession)return m.internalDebugLog("Session Not Ready To Listen"),void(u.showErrors&&u.error(new Error("Session Not Ready To Listen"),e));switch(u.action){case"subscribe":u.subscribeActionInput(e);break;case"events":u.subscribeEventsInput(e);break;default:throw new TypeError("Unknown Action Type")}}),u.setOPCUAConnected=function(e){u.opcuaClient=e,u.setNodeStatusTo("connected")},u.opcuaSessionStarted=function(e){u.opcuaSession=e,u.setNodeStatusTo("active")},u.connectorShutdown=function(e){m.internalDebugLog("Connector Shutdown"),e&&(u.opcuaClient=e)},!u.connector)throw new TypeError("Connector Not Valid");u.connector.on("connected",u.setOPCUAConnected),u.connector.on("session_started",u.opcuaSessionStarted),u.connector.on("after_reconnection",u.connectorShutdown),m.core.setNodeInitalState(u.connector.stateMachine.getMachineState(),u)})};
//# sourceMappingURL=maps/opcua-iiot-listener.js.map
