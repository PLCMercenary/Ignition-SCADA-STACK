/**
 * Created by clarkd on 21/5/17.
 */


// var q = new queue('./test/db.sqlite', 1);
// q.open()
// .then(function() {
// 	console.log('bla') ;
// })
// .catch(function(err) {
// 	console.log('inside error') ;
// 	console.log(err) ;
// 	return q.close() ;
// })
// .then(function(){
// 	q = new queue();
// 	q.open()
// 	.then(function(){
// 		console.log('bla')
// 		q.add('1') ;
//
// 	})
// })
// .catch(function(err) {
// 	console.log('inside error 2') ;
// 	console.log(err) ;
// })


// var q = new queue() ;
// q.open()
// .then(function() {
// 	q.add('1') ;
// 	console.log('Got to here') ;
// 	setTimeout(function(){},1000) ;
// })
// .catch(function(err) {
// 	console.log('Got to err') ;
// }) ;

// var q = new queue('/tmp/db.sqlite') ;

var Queue = require('./index') ;
var q = new Queue(':memory:') ;

var task1 = {
	data: "Data1"
} ;
var task2 = {
	data: "Data2"
} ;
var task3 = {
	data: "Data3"
} ;
var task4 = {
	data: "Data4"
} ;

q.on('open',function() {
	console.log('Opening SQLite DB') ;
}) ;

q.on('add',function(task) {
	console.log('Adding task: '+JSON.stringify(task)) ;
}) ;

q.on('start',function() {
	console.log('Starting queue') ;
}) ;

q.on('next',function(task) {
	console.log('Process task: ') ;
	console.log(JSON.stringify(task)) ;

	// Must tell Queue that we have finished this task
	// This call will schedule the next task (if there is one)
	q.done() ;
}) ;

// Stop the queue when it gets empty
q.on('empty',function() {
	console.log('Queue is empty') ;
	q.stop() ;
	q.close()
	.then(function() {
		process.exit(0) ;
	})
}) ;

q.on('stop',function() {
	console.log('Stopping queue') ;
}) ;

q.on('close',function() {
	console.log('Closing SQLite DB') ;
}) ;

q.open()
.then(function() {
	q.add(task1)
		.add(task2)
		.add(task3)
		.add(task4)
	.start() ;
})
.catch(function(err) {
	console.log('Error occurred:') ;
	console.log(err) ;
	process.exit(1) ;
}) ;
// process.on('SIGINT', function()  {
// 	console.log('Got SIGHUP signal.') ;
// 	q.close() ;
// 	process.exit(0) ;
// }) ;
