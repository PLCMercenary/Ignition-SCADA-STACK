"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};module.exports=function(t){require("source-map-support").install();var o=require("./core/opcua-iiot-core-filter"),n=require("underscore");t.nodes.registerType("OPCUA-IIoT-Result-Filter",function(e){t.nodes.createNode(this,e),this.nodeId=e.nodeId,this.datatype=e.datatype,this.fixedValue=e.fixedValue,this.fixPoint=2|parseInt(e.fixPoint),this.withPrecision=e.withPrecision,this.precision=2|parseInt(e.precision),this.entry=e.entry,this.justValue=e.justValue,this.withValueCheck=e.withValueCheck,this.minvalue=e.minvalue,this.maxvalue=e.maxvalue,this.defaultvalue=e.defaultvalue,this.topic=e.topic,this.name=e.name,this.showErrors=e.showErrors;var a=this;a.subscribed=!1,a.withValueCheck&&(a.minvalue=a.convertDataType(a.minvalue),a.maxvalue=a.convertDataType(a.maxvalue)),a.status({fill:"blue",shape:"ring",text:"new"}),a.nodeIdToFilter=function(e){var t=!0,r=o.core.buildNodesToRead(e);return r&&r.length&&(t=!r.some(function(e,t,r){return(e.nodeId||e).toString()===a.nodeId.toString()})),t},a.on("input",function(t){if(t.hasOwnProperty("payload")&&null!==t.payload&&void 0!==t.payload){if(!a.nodeIdToFilter(t)){if(t.addressSpaceItems){if(n.filter(t.addressSpaceItems,function(e){return e.nodeId===a.nodeId}).length<1)return}else if(t.topic!==a.nodeId)return;t.filtertype="filter";var e=t.payload;switch(t.nodetype){case"read":e=a.filterByReadType(t);break;case"write":e=a.filterByWriteType(t);break;case"listen":e=a.filterByListenType(t);break;default:a.showErrors&&a.error(new Error("unknown node type injected to filter for "+t.nodetype),t),o.internalDebugLog("unknown node type injected to filter for "+t.nodetype)}if(null!=e){e.hasOwnProperty("value")&&(e=e.value);var r=void 0===e?"undefined":_typeof(e);if(e.hasOwnProperty("datatype")&&(r=e.datatype||(void 0===e?"undefined":_typeof(e))),r&&r.toString()!==a.datatype.toString()&&(e=a.convertDataType(e)),null==e)a.showErrors&&a.error(new Error("converted result null or undefined"),t);else try{0<=a.fixPoint&&a.fixedValue&&(e=Number.parseFloat(e).toFixed(a.fixPoint),e=parseFloat(e)),0<=a.precision&&a.withPrecision&&(e=Number.parseFloat(e).toPrecision(a.precision),e=parseFloat(e)),a.withValueCheck&&(e<a.minvalue||e>a.maxvalue)&&(e=a.defaultvalue)}catch(e){a.showErrors&&a.error(e,t)}a.justValue?a.send({payload:e,topic:a.topic||t.topic,nodeId:a.nodeId}):a.send({payload:e,topic:a.topic||t.topic,nodeId:a.nodeId,input:t})}else o.internalDebugLog("result null or undefined"+JSON.stringify(t))}}else o.internalDebugLog("filtering message without payload "+JSON.stringify(t))}),a.filterByReadType=function(e){var t=null;return(t=e.payload.length>=a.entry?a.extractValueFromOPCUAArrayStructure(e,a.entry-1):a.extractValueFromOPCUAStructure(e)).hasOwnProperty("value")&&(t=t.value),t},a.extractValueFromOPCUAArrayStructure=function(e,t){var r=null,a=e.payload[t];return a?r=a.hasOwnProperty("value")?a.value.hasOwnProperty("value")?a.value.value:a.value:a:r},a.extractValueFromOPCUAStructure=function(e){return e.payload.hasOwnProperty("value")?e.payload.value.hasOwnProperty("value")?e.payload.value.value:e.payload.value:e.payload},a.filterByWriteType=function(e){var t=null;return(t=e.payload.hasOwnProperty("value")?e.payload.value:e.payload)&&t.hasOwnProperty("value")&&(t=t.value),t},a.filterByListenType=function(e){var t=null;return(t=e.payload&&e.payload.hasOwnProperty("value")?e.payload.value:e.payload)&&t.hasOwnProperty("value")&&(t=t.value),t},a.convertDataType=function(e){return o.internalDebugLog("data type convert for "+a.nodeId),o.core.convertDataValueByDataType({value:e},a.datatype)},a.status({fill:"green",shape:"dot",text:"active"})})};
//# sourceMappingURL=maps/opcua-iiot-result-filter.js.map
