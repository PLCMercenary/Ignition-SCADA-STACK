"use strict";module.exports=function(t){require("source-map-support").install();var a=require("./core/opcua-iiot-core-browser"),i=[];t.nodes.registerType("OPCUA-IIoT-Browser",function(e){t.nodes.createNode(this,e),this.nodeId=e.nodeId,this.name=e.name,this.justValue=e.justValue,this.sendNodesToRead=e.sendNodesToRead,this.sendNodesToBrowser=e.sendNodesToBrowser,this.sendNodesToListener=e.sendNodesToListener,this.singleBrowseResult=e.singleBrowseResult,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.connector=t.nodes.getNode(e.connector);var r=this;if(r.items=[],r.browseTopic=a.core.OBJECTS_ROOT,r.opcuaClient=null,r.opcuaSession=null,r.reconnectTimeout=1e3,r.setNodeStatusTo=function(e){var o=a.core.getNodeStatus(e,r.showStatusActivities);r.status({fill:o.fill,shape:o.shape,text:o.status})},r.transformToEntry=function(o){if(o)try{return o.toJSON()}catch(e){return a.internalDebugLog(e),{referenceTypeId:o.referenceTypeId.toString(),isForward:o.isForward,nodeId:o.nodeId.toString(),browseName:o.browseName.toString(),displayName:o.displayName,nodeClass:o.nodeClass.toString(),typeDefinition:o.typeDefinition.toString()}}else a.internalDebugLog("Empty Reference On Browse")},r.browseErrorHandling=function(e,o){var s=[];e?(s.push({displayName:{text:"Objects"},nodeId:a.core.OBJECTS_ROOT,browseName:"Objects"}),a.internalDebugLog("Browser Error "+e),r.showErrors&&r.error(e,o),a.core.isSessionBad(e)&&r.connector.resetBadSession()):(s=i,a.internalDebugLog("Browse Done With Error: "+s.length+" item(s)")),i=s},r.sendMessageBrowserResults=function(e,o){var s=[],n=[];o.forEach(function(e){e.references.forEach(function(e){a.internalDebugLog("Add Reference To List :"+e),i.push(r.transformToEntry(e)),e.nodeId&&(s.push(e.nodeId.toString()),n.push({name:e.browseName.name,nodeId:e.nodeId.toString(),datatypeName:e.typeDefinition.toString()}))})}),r.sendMessage(e,s,n)},r.browse=function(e,o){a.internalDebugLog("Browse Topic To Call Browse "+r.browseTopic),i=[],a.browse(e,r.browseTopic).then(function(e){r.sendMessageBrowserResults(o,e)}).catch(function(e){r.browseErrorHandling(e,o)})},r.browseNodeList=function(o,s){i=[],r.singleBrowseResult?a.browseAddressSpaceItems(o,s.addressSpaceItems).then(function(e){i=[],r.sendMessageBrowserResults(s,e)}).catch(function(e){r.browseErrorHandling(e,s)}):s.addressSpaceItems.map(function(e){return a.browse(o,e.nodeId).then(function(e){i=[],r.sendMessageBrowserResults(s,e)}).catch(function(e){r.browseErrorHandling(e,s)})})},r.sendMessage=function(e,o,s){var n=e;n.nodetype="browse",n.payload={browserItems:i},r.browseTopic&&""!==r.browseTopic&&(n.payload.browseTopic=r.browseTopic),r.justValue||(n.payload.browserItemsCount=i.length,n.payload.endpoint=r.connector.endpoint,n.payload.session=r.opcuaSession.name||"none"),r.sendNodesToRead&&o&&(n.nodesToRead=o,n.nodesToReadCount=o.length),r.sendNodesToListener&&s&&(n.addressItemsToRead=s,n.addressItemsToReadCount=s.length),r.sendNodesToBrowser&&s&&(n.addressItemsToBrowse=s,n.addressItemsToBrowseCount=s.length),r.send(n)},r.on("input",function(e){if(r.browseTopic=r.extractBrowserTopic(e),"OPEN"!==r.connector.stateMachine.getMachineState())return a.internalDebugLog("Client State Not Open On Browse"),void(r.showErrors&&r.error(new Error("Client Not Open On Browse"),e));r.opcuaSession?r.browseTopic&&""!==r.browseTopic?r.browse(r.opcuaSession,e):(e.addressItemsToBrowse&&(e.addressSpaceItems=e.addressItemsToBrowse),e.addressSpaceItems?r.browseNodeList(r.opcuaSession,e):r.error(new Error("No AddressSpace Items Or Root To Browse"),e)):r.error(new Error("Session Not Ready To Browse"),e)}),r.extractBrowserTopic=function(e){var o=void 0;return"browse"===e.payload.actiontype?e.payload.root&&e.payload.root.nodeId?(a.internalDebugLog("Root Selected External "+e.payload.root),o=r.browseByItem(e.payload.root.nodeId)||r.browseToRoot()):o=r.nodeId||r.browseToRoot():o=""!==e.topic&&e.topic.includes("=")?e.topic:r.nodeId,o},r.browseByItem=function(e){return a.detailDebugLog("Browse To Parent "+e),e},r.browseToRoot=function(){return a.detailDebugLog("Browse To Root "+a.core.OBJECTS_ROOT),a.core.OBJECTS_ROOT},r.setOPCUAConnected=function(e){r.opcuaClient=e,r.setNodeStatusTo("connected")},r.opcuaSessionStarted=function(e){r.opcuaSession=e,r.setNodeStatusTo("active")},r.connectorShutdown=function(e){a.internalDebugLog("Connector Shutdown"),e&&(r.opcuaClient=e)},!r.connector)throw new TypeError("Connector Not Valid");r.connector.on("connected",r.setOPCUAConnected),r.connector.on("session_started",r.opcuaSessionStarted),r.connector.on("after_reconnection",r.connectorShutdown),a.core.setNodeInitalState(r.connector.stateMachine.getMachineState(),r)}),t.httpAdmin.get("/opcuaIIoT/browse/:id/:nodeId",t.auth.needsPermission("opcuaIIoT.browse"),function(e,o){var s=t.nodes.getNode(e.params.id),n=[],r=decodeURIComponent(e.params.nodeId)||a.core.OBJECTS_ROOT;s.opcuaSession?a.browse(s.opcuaSession,r).then(function(e){e.browseResult.forEach(function(e){e.references&&e.references.length?e.references.forEach(function(e){n.push(s.transformToEntry(e))}):a.detailDebugLog(JSON.stringify(e))}),o.json(n),i=n}).catch(function(e){a.internalDebugLog("Browser Error "+e),s.showErrors&&s.error(e,{payload:"Browse Internal Error"}),n.push({displayName:{text:"Objects"},nodeId:a.core.OBJECTS_ROOT,browseName:"Objects"}),o.json(n),i=n}):(o.json(n),i=n)})};
//# sourceMappingURL=maps/opcua-iiot-browser.js.map
