"use strict";module.exports=function(s){require("source-map-support").install();var h=require("./core/opcua-iiot-core-client");s.nodes.registerType("OPCUA-IIoT-Read",function(e){s.nodes.createNode(this,e),this.attributeId=e.attributeId||0,this.maxAge=e.maxAge||1,this.depth=e.depth||1,this.name=e.name,this.justValue=e.justValue,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.parseStrings=e.parseStrings,this.connector=s.nodes.getNode(e.connector);var l=this;if(l.reconnectTimeout=1e3,l.sessionTimeout=null,l.opcuaClient=null,l.opcuaSession=null,l.statusLog=function(e){s.settings.verbose&&l.showStatusActivities&&h.readDebugLog("Status: "+e)},l.setNodeStatusTo=function(e){l.statusLog(e);var t=h.core.getNodeStatus(e,l.showStatusActivities);l.status({fill:t.fill,shape:t.shape,text:t.status})},l.handleReadError=function(e,t){h.readDebugLog(e),l.showErrors&&l.error(e,t),h.core.isSessionBad(e)&&l.connector.resetBadSession()},l.readFromSession=function(e,t,r){switch(h.readDebugLog("Read With AttributeId "+l.attributeId),parseInt(l.attributeId)){case 0:h.readAllAttributes(e,t).then(function(e){try{l.send(l.buildResultMessage(r,"AllAttributes",e))}catch(e){l.handleReadError(e,r)}}).catch(function(e){l.handleReadError(e,r)});break;case 13:h.readVariableValue(e,t).then(function(e){try{var t=l.buildResultMessage(r,"VariableValue",e);l.send(t)}catch(e){l.handleReadError(e,r)}}).catch(function(e){l.handleReadError(e,r)});break;case 130:var o=new Date;l.historyStart=new Date(o.getDate()-1),l.historyEnd=o,h.readHistoryValue(e,t,l.historyStart,l.historyEnd).then(function(e){try{var t=l.buildResultMessage(r,"HistoryValue",e);t.historyStart=l.historyStart,t.historyEnd=l.historyEnd,l.send(t)}catch(e){l.handleReadError(e,r)}}).catch(function(e){l.handleReadError(e,r)});break;default:var a=null,n=[],s=!0,i=!1,u=void 0;try{for(var c,d=t[Symbol.iterator]();!(s=(c=d.next()).done);s=!0)a={nodeId:c.value,attributeId:Number(l.attributeId)||null},n.push(a)}catch(e){i=!0,u=e}finally{try{!s&&d.return&&d.return()}finally{if(i)throw u}}h.read(e,n,l.maxAge).then(function(e){try{var t=l.buildResultMessage(r,"Default",e);t.maxAge=l.maxAge,l.send(t)}catch(e){l.handleReadError(e,r)}}).catch(function(e){l.handleReadError(e,r)})}},l.buildResultMessage=function(t,e,r){var o=t;o.payload={},o.nodetype="read",o.readtype=e,o.attributeId=l.attributeId;var a={};a=l.justValue?JSON.stringify(r.results,null,2):JSON.stringify(r,null,2);try{s.util.setMessageProperty(o,"payload",JSON.parse(a))}catch(e){l.showErrors&&(l.warn("JSON not to parse from string for dataValues type "+JSON.stringify(r,null,2)),l.error(e,t)),o.payload=a,o.error=e.message}if(!l.justValue)try{o.resultsConverted={};var n=JSON.stringify(r.results,null,2);s.util.setMessageProperty(o,"resultsConverted",JSON.parse(n))}catch(e){l.showErrors&&(l.warn("JSON not to parse from string for dataValues type "+r.results),l.error(e,t)),o.resultsConverted=null,o.error=e.message}return o},l.on("input",function(e){if("OPEN"!==l.connector.stateMachine.getMachineState())return h.readDebugLog("Client State Not Open On Read"),void(l.showErrors&&l.error(new Error("Client Not Open On Read"),e));l.opcuaSession?l.readFromSession(l.opcuaSession,h.core.buildNodesToRead(e),e):l.error(new Error("Session Not Ready To Read"),e)}),l.setOPCUAConnected=function(e){l.opcuaClient=e,l.setNodeStatusTo("connected")},l.opcuaSessionStarted=function(e){l.opcuaSession=e,l.setNodeStatusTo("active")},l.connectorShutdown=function(e){h.readDebugLog("Connector Shutdown"),e&&(l.opcuaClient=e)},!l.connector)throw new TypeError("Connector Not Valid");l.connector.on("connected",l.setOPCUAConnected),l.connector.on("session_started",l.opcuaSessionStarted),l.connector.on("after_reconnection",l.connectorShutdown),h.core.setNodeInitalState(l.connector.stateMachine.getMachineState(),l)})};
//# sourceMappingURL=maps/opcua-iiot-read.js.map
