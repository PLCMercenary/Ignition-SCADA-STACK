"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};require("source-map-support").install();var de=de||{biancoroyal:{opcua:{iiot:{core:{}}}}};de.biancoroyal.opcua.iiot.core.nodeOPCUA=de.biancoroyal.opcua.iiot.core.nodeOPCUA||require("node-opcua"),de.biancoroyal.opcua.iiot.core.nodeOPCUAId=de.biancoroyal.opcua.iiot.core.nodeOPCUAId||require("node-opcua-nodeid"),de.biancoroyal.opcua.iiot.core.internalDebugLog=de.biancoroyal.opcua.iiot.core.internalDebugLog||require("debug")("opcuaIIoT:core"),de.biancoroyal.opcua.iiot.core.detailDebugLog=de.biancoroyal.opcua.iiot.core.detailDebugLog||require("debug")("opcuaIIoT:core:details"),de.biancoroyal.opcua.iiot.core.specialDebugLog=de.biancoroyal.opcua.iiot.core.specialDebugLog||require("debug")("opcuaIIoT:core:special"),de.biancoroyal.opcua.iiot.core.OBJECTS_ROOT=de.biancoroyal.opcua.iiot.core.OBJECTS_ROOT||"ns=0;i=84",de.biancoroyal.opcua.iiot.core.TEN_SECONDS_TIMEOUT=de.biancoroyal.opcua.iiot.core.TEN_SECONDS_TIMEOUT||10,de.biancoroyal.opcua.iiot.core.os=de.biancoroyal.opcua.iiot.core.os||require("os"),de.biancoroyal.opcua.iiot.core.isWindows=de.biancoroyal.opcua.iiot.core.isWindows||/^win/.test(de.biancoroyal.opcua.iiot.core.os.platform()),de.biancoroyal.opcua.iiot.core.internalDebugLog(de.biancoroyal.opcua.iiot.core.os.endianness()),de.biancoroyal.opcua.iiot.core.internalDebugLog(de.biancoroyal.opcua.iiot.core.os.hostname()),de.biancoroyal.opcua.iiot.core.internalDebugLog(de.biancoroyal.opcua.iiot.core.os.platform()),de.biancoroyal.opcua.iiot.core.internalDebugLog(de.biancoroyal.opcua.iiot.core.os.type()),de.biancoroyal.opcua.iiot.core.internalDebugLog(de.biancoroyal.opcua.iiot.core.os.arch()),de.biancoroyal.opcua.iiot.core.getPathFromRequireResolve=function(e){var a="";return a=this.isWindows?e.replace("\\index.js",""):e.replace("/index.js",""),this.internalDebugLog("path to node-opcua: "+a),a},de.biancoroyal.opcua.iiot.core.getNodeOPCUAPath=function(){return this.getPathFromRequireResolve(require.resolve("node-opcua"))},de.biancoroyal.opcua.iiot.core.getNodeOPCUAClientPath=function(){return this.getPathFromRequireResolve(require.resolve("node-opcua-client"))},de.biancoroyal.opcua.iiot.core.getNodeOPCUAServerPath=function(){return this.getPathFromRequireResolve(require.resolve("node-opcua-server"))},de.biancoroyal.opcua.iiot.core.getTimeUnitName=function(e){var a="";switch(e){case"ms":a="msec.";break;case"s":a="sec.";break;case"m":a="min.";break;case"h":a="h."}return a},de.biancoroyal.opcua.iiot.core.calcMillisecondsByTimeAndUnit=function(e,a){var o=void 0;switch(a){case"ms":o=e;break;case"s":o=1e3*e;break;case"m":o=6e4*e;break;case"h":o=36e5*e;break;default:o=1e4}return o},de.biancoroyal.opcua.iiot.core.buildBrowseMessage=function(e){return{topic:e,nodeId:"",browseName:"",nodeClassType:"",typeDefinition:"",payload:""}},de.biancoroyal.opcua.iiot.core.toInt32=function(e){var a=e;return a>=Math.pow(2,15)?a=e-Math.pow(2,16):a},de.biancoroyal.opcua.iiot.core.getNodeStatus=function(e,a){var o="yellow",t="ring";switch(e){case"initialize":case"connecting":o="yellow";break;case"connected":case"keepalive":case"subscribe":case"started":a||(e="active",t="dot"),o="green";break;case"active":case"subscribed":case"listening":o="green",t="dot";break;case"disconnected":case"terminated":o="red";break;case"waiting":o="blue",t="dot",e="waiting ...";break;case"error":o="red",t="dot";break;default:e||(o="blue",e="waiting ...")}return{fill:o,shape:t,status:e}},de.biancoroyal.opcua.iiot.core.buildNewVariant=function(e,a){var o=de.biancoroyal.opcua.iiot.core.nodeOPCUA,t=null;switch(this.detailDebugLog("buildNewVariant datatype: "+e+" value:"+a),e){case"Float":case o.DataType.Float:t={dataType:o.DataType.Float,value:parseFloat(a)};break;case"Double":case o.DataType.Double:t={dataType:o.DataType.Double,value:parseFloat(a)};break;case"UInt16":case o.DataType.UInt16:var i=new Uint16Array([a]);t={dataType:o.DataType.UInt16,value:i[0]};break;case"UInt32":case o.DataType.UInt32:var r=new Uint32Array([a]);t={dataType:o.DataType.UInt32,value:r[0]};break;case"Int32":case o.DataType.Int32:t={dataType:o.DataType.Int32,value:parseInt(a)};break;case"Int16":case o.DataType.Int16:t={dataType:o.DataType.Int16,value:parseInt(a)};break;case"Int64":case o.DataType.Int64:t={dataType:o.DataType.Int64,value:parseInt(a)};break;case"Boolean":case o.DataType.Boolean:t=a&&"false"!==a?{dataType:o.DataType.Boolean,value:!0}:{dataType:o.DataType.Boolean,value:!1};break;case"LocalizedText":case o.DataType.LocalizedText:t={dataType:o.DataType.LocalizedText,value:JSON.parse(a)};break;case"DateTime":case o.DataType.DateTime:t={dataType:o.DataType.DateTime,value:new Date(a)};break;default:t={dataType:o.DataType.String,value:a}}return this.detailDebugLog("buildNewVariant variantValue: "+JSON.stringify(t)),t},de.biancoroyal.opcua.iiot.core.getVariantValue=function(e,a){var o=de.biancoroyal.opcua.iiot.core.nodeOPCUA;switch(e){case"Float":case"Double":case o.DataType.Double:return parseFloat(a);case"UInt16":case o.DataType.UInt16:return new Uint16Array([a])[0];case"UInt32":case o.DataType.UInt32:return new Uint32Array([a])[0];case"Int16":case o.DataType.Int16:case"Int32":case"Integer":case o.DataType.Int32:case"Int64":case o.DataType.Int64:return parseInt(a);case"Boolean":case o.DataType.Boolean:return a&&"false"!==a;case"DateTime":case o.DataType.DateTime:return new Date(a);case"String":case o.DataType.String:return"string"!=typeof a?a.toString():a;default:return a}},de.biancoroyal.opcua.iiot.core.getBasicDataTypes=function(){var e=de.biancoroyal.opcua.iiot.core.nodeOPCUA;return[{name:"Null",dataType:e.DataType.Null},{name:"Boolean",dataType:e.DataType.Boolean},{name:"SByte",dataType:e.DataType.SByte},{name:"Byte",dataType:e.DataType.Byte},{name:"Int16",dataType:e.DataType.Int16},{name:"UInt16",dataType:e.DataType.UInt16},{name:"Int32",dataType:e.DataType.Int32},{name:"UInt32",dataType:e.DataType.UInt32},{name:"Int64",dataType:e.DataType.Int64},{name:"UInt64",dataType:e.DataType.UInt64},{name:"Float",dataType:e.DataType.Float},{name:"Double",dataType:e.DataType.Double},{name:"DateTime",dataType:e.DataType.DateTime},{name:"String",dataType:e.DataType.String},{name:"Guid",dataType:e.DataType.Guid},{name:"ByteString",dataType:e.DataType.ByteString},{name:"XmlElement",dataType:e.DataType.XmlElement},{name:"NodeId",dataType:e.DataType.NodeId},{name:"ExpandedNodeId",dataType:e.DataType.ExpandedNodeId},{name:"StatusCode",dataType:e.DataType.StatusCode},{name:"LocalizedText",dataType:e.DataType.LocalizedText},{name:"ExtensionObject",dataType:e.DataType.ExtensionObject},{name:"DataValue",dataType:e.DataType.DataValue},{name:"Variant",dataType:e.DataType.Variant},{name:"DiagnosticInfo",dataType:e.DataType.DiagnosticInfo}]},de.biancoroyal.opcua.iiot.core.convertDataValue=function(e){return de.biancoroyal.opcua.iiot.core.convertDataValueByDataType(e,e.dataType)},de.biancoroyal.opcua.iiot.core.convertDataValueByDataType=function(e,a){var o=de.biancoroyal.opcua.iiot.core.nodeOPCUA,t=null;if(!e.hasOwnProperty("value"))return this.specialDebugLog("value has no value and that is not allowed "+JSON.stringify(e)),e;var i=_typeof(e.value);this.detailDebugLog("convertDataValue: "+JSON.stringify(e)+" value origin type "+i+" convert to "+a);try{switch(a){case"NodeId":case o.DataType.NodeId:t=e.value.toString();break;case"NodeIdType":case o.DataType.NodeIdType:t=e.value instanceof Buffer?e.value.toString():e.value;break;case"ByteString":case o.DataType.ByteString:t=e.value;break;case"Byte":case o.DataType.Byte:t="boolean"===i?e.value?1:0:parseInt(e.value);break;case o.DataType.QualifiedName:t=e.value.toString();break;case"LocalizedText":case o.DataType.LocalizedText:t=e.value;break;case"Float":case o.DataType.Float:t=isNaN(e.value)?e.value:parseFloat(e.value);break;case"Double":case o.DataType.Double:t=isNaN(e.value)?e.value:parseFloat(e.value);break;case"UInt16":case o.DataType.UInt16:t=new Uint16Array([e.value])[0];break;case"UInt32":case o.DataType.UInt32:t=new Uint32Array([e.value])[0];break;case"Int16":case o.DataType.Int16:case"Int32":case o.DataType.Int32:case"Int64":case o.DataType.Int64:t="boolean"===i?e.value?1:0:isNaN(e.value)?e.value:parseInt(e.value);break;case"Boolean":case o.DataType.Boolean:t="boolean"===i?e.value:isNaN(e.value)?e.value&&"false"!==e.value.toString().toLowerCase():e.value;break;case"String":case o.DataType.String:t="string"!==i?e.value.toString():e.value;break;case"Null":case o.DataType.Null:t=null;break;default:this.internalDebugLog("convertDataValue unused DataType: "+a),t=e.hasOwnProperty("value")?e.value:null}}catch(e){this.detailDebugLog("convertDataValue "+e)}return this.detailDebugLog("convertDataValue is: "+t),t},de.biancoroyal.opcua.iiot.core.regex_ns_i=/ns=([0-9]+);i=([0-9]+)/,de.biancoroyal.opcua.iiot.core.regex_ns_s=/ns=([0-9]+);s=(.*)/,de.biancoroyal.opcua.iiot.core.regex_ns_b=/ns=([0-9]+);b=(.*)/,de.biancoroyal.opcua.iiot.core.regex_ns_g=/ns=([0-9]+);g=(.*)/,de.biancoroyal.opcua.iiot.core.parseNamspaceFromMsgTopic=function(e){var a=null;return e&&e.topic&&(a=e.topic.substring(3,e.topic.indexOf(";"))),a},de.biancoroyal.opcua.iiot.core.parseNamspaceFromItemNodeId=function(e){var a=null,o=e.nodeId||e;return o&&(a=o.substring(3,o.indexOf(";"))),a},de.biancoroyal.opcua.iiot.core.parseIdentifierFromMsgTopic=function(e){var a=null;return e&&e.topic&&(a=e.topic.toString().includes(";i=")?{identifier:parseInt(e.topic.substring(e.topic.indexOf(";i=")+3)),type:de.biancoroyal.opcua.iiot.core.nodeOPCUAId.NodeIdType.NUMERIC}:e.topic.toString().includes(";b=")?{identifier:e.topic.substring(e.topic.indexOf(";b=")+3),type:de.biancoroyal.opcua.iiot.core.nodeOPCUAId.NodeIdType.BYTESTRING}:{identifier:e.topic.substring(e.topic.indexOf(";s=")+3),type:de.biancoroyal.opcua.iiot.core.nodeOPCUAId.NodeIdType.STRING}),a},de.biancoroyal.opcua.iiot.core.parseIdentifierFromItemNodeId=function(e){var a=null,o=e.nodeId||e;return o&&(a=o.includes(";i=")?{identifier:parseInt(o.substring(o.indexOf(";i=")+3)),type:de.biancoroyal.opcua.iiot.core.nodeOPCUAId.NodeIdType.NUMERIC}:o.includes(";b=")?{identifier:o.substring(o.indexOf(";b=")+3),type:de.biancoroyal.opcua.iiot.core.nodeOPCUAId.NodeIdType.STRING}:{identifier:o.substring(o.indexOf(";s=")+3),type:de.biancoroyal.opcua.iiot.core.nodeOPCUAId.NodeIdType.STRING}),a},de.biancoroyal.opcua.iiot.core.newOPCUANodeIdFromItemNodeId=function(e){var a=de.biancoroyal.opcua.iiot.core.parseNamspaceFromItemNodeId(e),o=de.biancoroyal.opcua.iiot.core.parseIdentifierFromItemNodeId(e);return this.internalDebugLog("newOPCUANodeIdFromItemNodeId: "+JSON.stringify(e)+" -> "+JSON.stringify(o)+" namespace:"+a),new de.biancoroyal.opcua.iiot.core.nodeOPCUAId.NodeId(o.type,o.identifier,a)},de.biancoroyal.opcua.iiot.core.newOPCUANodeIdFromMsgTopic=function(e){var a=de.biancoroyal.opcua.iiot.core.parseNamspaceFromMsgTopic(e),o=de.biancoroyal.opcua.iiot.core.parseIdentifierFromMsgTopic(e);return this.internalDebugLog("newOPCUANodeIdFromMsgTopic: "+JSON.stringify(o)),new de.biancoroyal.opcua.iiot.core.nodeOPCUAId.NodeId(o.type,o.identifier,a)},de.biancoroyal.opcua.iiot.core.buildNodesToWrite=function(e){var a=de.biancoroyal.opcua.iiot.core.nodeOPCUA,o=[];this.detailDebugLog("buildNodesToWrite input: "+JSON.stringify(e));var t=null;if(!e.addressSpaceItems||!e.addressSpaceItems.length){var i=e.payload.nodesToWrite||e.nodesToWrite;i&&i.length&&(e.addressSpaceItems=i)}if(e.addressSpaceItems){var r=0;if(e.valuesToWrite){var n=!0,c=!1,d=void 0;try{for(var s,l=e.addressSpaceItems[Symbol.iterator]();!(n=(s=l.next()).done);n=!0)t=s.value,o.push({nodeId:this.newOPCUANodeIdFromItemNodeId(t),attributeId:a.AttributeIds.Value,indexRange:null,value:{value:this.buildNewVariant(t.datatypeName,e.valuesToWrite[r++])}})}catch(e){c=!0,d=e}finally{try{!n&&l.return&&l.return()}finally{if(c)throw d}}}else{var u=!0,p=!1,y=void 0;try{for(var b,T=e.addressSpaceItems[Symbol.iterator]();!(u=(b=T.next()).done);u=!0)(t=b.value).value?o.push({nodeId:this.newOPCUANodeIdFromItemNodeId(t),attributeId:a.AttributeIds.Value,indexRange:null,value:{value:this.buildNewVariant(t.datatypeName,t.value)}}):o.push({nodeId:this.newOPCUANodeIdFromItemNodeId(t),attributeId:a.AttributeIds.Value,indexRange:null,value:{value:this.buildNewVariant(t.datatypeName,e.payload.length&&e.payload.length===e.addressSpaceItems.length?e.payload[r++]:e.payload)}})}catch(e){p=!0,y=e}finally{try{!u&&T.return&&T.return()}finally{if(p)throw y}}}}return this.internalDebugLog("buildNodesToWrite output: "+JSON.stringify(o)),o},de.biancoroyal.opcua.iiot.core.buildNodesToRead=function(e){var a=[],o=null;this.detailDebugLog("buildNodesToRead input: "+JSON.stringify(e));var t=e.payload.nodesToRead||e.payload.nodesToWrite;if(t&&t.length){var i=!0,r=!1,n=void 0;try{for(var c,d=t[Symbol.iterator]();!(i=(c=d.next()).done);i=!0)o=(o=c.value).nodeId||o,a.push(o.toString())}catch(e){r=!0,n=e}finally{try{!i&&d.return&&d.return()}finally{if(r)throw n}}}else{var s=e.nodesToRead||e.nodesToWrite;if(s&&s.length){var l=!0,u=!1,p=void 0;try{for(var y,b=s[Symbol.iterator]();!(l=(y=b.next()).done);l=!0)o=(o=y.value).nodeId||o,a.push(o.toString())}catch(e){u=!0,p=e}finally{try{!l&&b.return&&b.return()}finally{if(u)throw p}}}else if(e.payload.addressSpaceItems&&e.payload.addressSpaceItems.length){var T=!0,I=!1,g=void 0;try{for(var D,v=e.payload.addressSpaceItems[Symbol.iterator]();!(T=(D=v.next()).done);T=!0)o=D.value,a.push(o.nodeId)}catch(e){I=!0,g=e}finally{try{!T&&v.return&&v.return()}finally{if(I)throw g}}}else if(e.addressSpaceItems&&e.addressSpaceItems.length){var f=!0,m=!1,N=void 0;try{for(var h,S=e.addressSpaceItems[Symbol.iterator]();!(f=(h=S.next()).done);f=!0)o=h.value,a.push(o.nodeId)}catch(e){m=!0,N=e}finally{try{!f&&S.return&&S.return()}finally{if(m)throw N}}}}return this.internalDebugLog("buildNodesToRead output: "+JSON.stringify(a)),a},de.biancoroyal.opcua.iiot.core.buildNodesToListen=function(e){return e.addressItemsToRead||e.addressSpaceItems},de.biancoroyal.opcua.iiot.core.availableMemory=function(){return this.os.freemem()/this.os.totalmem()*100},de.biancoroyal.opcua.iiot.core.isSessionBad=function(e){return e.toString().includes("BadSession")||e.toString().includes("Invalid Channel")},de.biancoroyal.opcua.iiot.core.setNodeInitalState=function(e,a){switch(e){case"INIT":a.setNodeStatusTo("connecting");break;case"OPEN":a.opcuaSession=a.connector.opcuaSession,a.setNodeStatusTo("active");break;case"LOCKED":a.setNodeStatusTo("locked");break;case"UNLOCKED":a.setNodeStatusTo("unlocked");break;default:a.setNodeStatusTo("waiting")}},de.biancoroyal.opcua.iiot.core.isNodeId=function(e){if(!e||!e.identifierType)return!1;switch(e.identifierType){case this.nodeOPCUA.NodeIdType.NUMERIC:case this.nodeOPCUA.NodeIdType.STRING:case this.nodeOPCUA.NodeIdType.GUID:return!0;default:return!1}},module.exports=de.biancoroyal.opcua.iiot.core;
//# sourceMappingURL=../maps/core/opcua-iiot-core.js.map
